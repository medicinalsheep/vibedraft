<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vibedraft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@600&display=swap');

        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        .tail-container {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1a1f3a 100%);
        }

        .logo-font { font-family: 'Space Grotesk', sans-serif; letter-spacing: -1px; }

        .viewer-svg {
            background: #ffffff;
            box-shadow: 0 20px 40px rgba(0,0,0,0.35);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            max-height: 78vh;
            max-width: 100%;
            margin: 0 auto;
        }

        .title-block {
            background: linear-gradient(to bottom, #f8fafc, #f0f4f8);
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 11px;
            line-height: 1.05;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin: 1.5rem auto;
            max-width: 100%;
        }

        .tab-active { border-bottom: 2px solid #60a5fa; color: #60a5fa; font-weight: 600; }

        .error-badge { background: #fee2e2; border: 1px solid #fecaca; color: #991b1b; border-radius: 6px; }
        .success-badge { background: #dcfce7; border: 1px solid #bbf7d0; color: #166534; border-radius: 6px; }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }

        .template-button {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 10px;
            padding: 1.2rem 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .template-button:hover {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            border-color: #60a5fa;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(96,165,250,0.18);
        }

        input:disabled, textarea:disabled, select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #334155 !important;
        }

        input, textarea, select { transition: all 0.2s ease; }
        input:focus, textarea:focus, select:focus { box-shadow: 0 0 0 3px rgba(96,165,250,0.12); }
    </style>
</head>
<body class="tail-container text-slate-100 overflow-hidden h-screen flex flex-col">

    <nav class="bg-slate-900/50 backdrop-blur border-b border-slate-700/50 px-8 py-4 flex items-center justify-between">
        <div class="flex items-center gap-x-12">
            <div class="flex items-center gap-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center text-white font-bold logo-font text-lg shadow-lg">VD</div>
                <div>
                    <h1 class="logo-font text-3xl font-bold tracking-tight text-white">vibedraft</h1>
                    <span class="text-xs font-medium text-cyan-400">v0.6</span>
                </div>
            </div>
            <div class="flex gap-x-8 text-sm font-medium">
                <button onclick="switchTab(0)" id="tab-0" class="tab-active px-4 py-2 transition-colors duration-200 text-slate-300 hover:text-white">VIEWER</button>
                <button onclick="switchTab(1)" id="tab-1" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">CODE</button>
                <button onclick="switchTab(2)" id="tab-2" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">3D</button>
                <button onclick="switchTab(3)" id="tab-3" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">AI</button>
                <button onclick="switchTab(4)" id="tab-4" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">TEMPLATES</button>
            </div>
        </div>
        <div class="flex items-center gap-x-3">
            <button onclick="newDrawing()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/50 transition-colors text-slate-300 hover:text-white">
                <i data-lucide="file-plus" class="w-4 h-4"></i><span class="text-xs font-medium">New</span>
            </button>
            <button onclick="saveDrawing()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/50 transition-colors text-slate-300 hover:text-white">
                <i data-lucide="save" class="w-4 h-4"></i><span class="text-xs font-medium">Save</span>
            </button>
            <div class="w-px h-6 bg-slate-700/50"></div>
            <button onclick="exportSVG()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 hover:text-blue-300">
                <i data-lucide="file-image" class="w-4 h-4"></i><span class="text-xs font-medium">SVG</span>
            </button>
            <button onclick="exportPDF()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 hover:text-blue-300">
                <i data-lucide="file-text" class="w-4 h-4"></i><span class="text-xs font-medium">PDF</span>
            </button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR -->
        <div class="w-80 bg-slate-900/30 backdrop-blur border-r border-slate-700/50 p-6 flex flex-col overflow-y-auto space-y-6">
            <div class="flex items-center justify-between">
                <label class="text-sm font-medium text-slate-300 flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="include-title-block" checked onchange="toggleTitleBlock()">
                    <span>Include Title Block & Metadata</span>
                </label>
            </div>

            <div id="project-info-section">
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Project Info</div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Company Logo</label>
                        <label class="block">
                            <div class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-xs text-slate-400 hover:border-blue-500 cursor-pointer transition-colors text-center">
                                üì∑ Upload Logo
                            </div>
                            <input type="file" id="logo-upload" accept="image/*" onchange="uploadLogo()" style="display:none;">
                        </label>
                        <div id="logo-preview" class="mt-2 h-12 bg-slate-800/50 border border-slate-700 rounded-lg flex items-center justify-center text-xs text-slate-500"></div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Drawing Title <span class="text-red-400">*</span></label>
                        <input type="text" id="meta-title" value="" onchange="validateRequired()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Drawing Number <span class="text-red-400">*</span></label>
                        <input type="text" id="meta-dwg" value="" onchange="validateRequired()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Revision <span class="text-red-400">*</span></label>
                        <input type="text" id="meta-rev" value="A" onchange="validateRequired()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Material</label>
                        <input type="text" id="meta-material" value="" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Drawn By</label>
                        <input type="text" id="meta-drawn-by" value="" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>

            <div class="border-t border-slate-700/30 pt-6">
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Drawing Format</div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Paper Size</label>
                        <select id="paper-size" onchange="updatePaperDimensions()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                            <option value="letter" selected>A Size ‚Äì Letter (8.5 √ó 11")</option>
                            <option value="tabloid">B Size ‚Äì Tabloid (11 √ó 17")</option>
                            <option value="arch_d">D Size ‚Äì ARCH D (24 √ó 36")</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-slate-400 font-medium block mb-2">Width (px)</label>
                            <input type="number" id="paper-width" value="1056" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 font-medium block mb-2">Height (px)</label>
                            <input type="number" id="paper-height" value="816" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-t border-slate-700/30 pt-6">
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Units & Scale</div>
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between text-xs mb-3">
                            <span class="text-slate-400 font-medium">Unit System</span>
                            <span id="units-label" class="font-semibold text-blue-400">INCHES</span>
                        </div>
                        <div class="flex bg-slate-800/50 rounded-lg p-1 border border-slate-700">
                            <button onclick="setUnits(0)" id="unit-in" class="flex-1 py-2 text-xs rounded-md font-semibold bg-blue-600 text-white">INCHES</button>
                            <button onclick="setUnits(1)" id="unit-mm" class="flex-1 py-2 text-xs rounded-md font-semibold text-slate-400 hover:text-slate-100">MM</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Scale</label>
                        <input type="text" id="meta-scale" value="1:1" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>

            <div class="border-t border-slate-700/30 pt-6 mt-auto">
                <button onclick="validateDrawing()" class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 rounded-lg text-sm font-semibold text-white transition-all shadow-lg hover:shadow-xl">
                    VALIDATE & REFRESH
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 flex flex-col bg-slate-950/50 overflow-hidden">
            <div id="viewer-panel" class="flex-1 flex flex-col items-center justify-center p-8 overflow-auto">
                <div id="svg-wrapper" class="relative cursor-grab active:cursor-grabbing w-full max-w-[95%] flex justify-center">
                    <div id="svg-container" class="viewer-svg"></div>
                </div>
                <div id="title-block" class="title-block grid grid-cols-12 p-6 text-slate-900 mt-6"></div>
            </div>

            <div id="code-panel" class="flex-1 hidden flex-col p-8 bg-slate-900/50 backdrop-blur overflow-hidden">
                <div class="max-w-6xl mx-auto w-full h-full flex flex-col space-y-4">
                    <div>
                        <h2 class="text-base font-semibold text-slate-100 mb-4">SVG Code</h2>
                        <div class="flex gap-x-3 flex-wrap">
                            <button onclick="validateAndShowErrors()" class="px-4 py-2.5 bg-purple-600/20 hover:bg-purple-600/30 rounded-lg border border-purple-500/50 text-purple-400 text-xs font-medium transition-all duration-200">VALIDATE</button>
                            <button onclick="loadCodeFromTextarea()" class="px-4 py-2.5 bg-emerald-600/20 hover:bg-emerald-600/30 rounded-lg border border-emerald-500/50 text-emerald-400 text-xs font-medium transition-all duration-200">LOAD CODE</button>
                            <button onclick="copyCodeWithMetadata()" class="px-4 py-2.5 bg-cyan-600/20 hover:bg-cyan-600/30 rounded-lg border border-cyan-500/50 text-cyan-400 text-xs font-medium transition-all duration-200">COPY + META</button>
                            <button onclick="copyCode()" class="px-4 py-2.5 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg border border-slate-700 text-slate-300 text-xs font-medium transition-all duration-200">COPY SVG</button>
                            <button onclick="copyGrokPrompt()" class="px-4 py-2.5 bg-blue-600/20 hover:bg-blue-600/30 rounded-lg border border-blue-500/50 text-blue-400 text-xs font-medium transition-all duration-200">GROK PROMPT</button>
                            <button onclick="loadFromJSON()" class="px-4 py-2.5 bg-green-600/20 hover:bg-green-600/30 rounded-lg border border-green-500/50 text-green-400 text-xs font-medium transition-all duration-200">LOAD JSON</button>
                            <button onclick="clearAllData()" class="px-4 py-2.5 bg-red-600/20 hover:bg-red-600/30 rounded-lg border border-red-500/50 text-red-400 text-xs font-medium transition-all duration-200">CLEAR ALL</button>
                        </div>
                    </div>
                    <div id="validation-panel" class="hidden p-4 rounded-lg border border-yellow-500/50 bg-yellow-500/10">
                        <div class="font-semibold text-yellow-400 mb-3 text-sm">Validation Results</div>
                        <div id="validation-output" class="text-xs text-yellow-200 space-y-1"></div>
                    </div>
                    <textarea id="code-text" placeholder="Paste SVG code here..." class="flex-1 bg-slate-950/50 border border-slate-700 font-mono text-xs p-6 text-emerald-300 rounded-lg resize-none focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></textarea>
                </div>
            </div>

            <div id="three-panel" class="flex-1 hidden bg-slate-950 relative rounded-lg m-8">
                <canvas id="three-canvas" class="w-full h-full rounded-lg"></canvas>
            </div>

            <div id="ai-panel" class="flex-1 hidden flex-col p-8 bg-slate-900/50 backdrop-blur overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full space-y-6">
                    <div>
                        <h2 class="text-lg font-bold text-white mb-4">ü§ñ AI Code Generator</h2>
                        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-6 space-y-4">
                            <div>
                                <label class="text-sm font-medium text-slate-300 block mb-2">Describe Your Drawing</label>
                                <textarea id="ai-prompt" placeholder="Create a 6 √ó 4 inch mounting plate with four 0.5 inch holes in a rectangular pattern..." class="w-full px-4 py-3 bg-slate-950/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500 resize-none h-24"></textarea>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="copyAIPromptWithMetadata()" class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-semibold text-white transition-all">üìã Copy Prompt + Metadata</button>
                                <button onclick="copyDirectLink()" class="flex-1 px-4 py-2.5 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm font-semibold text-white transition-all">üîó Copy Link for AI</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-base font-semibold text-emerald-400 uppercase tracking-wider mb-4">üìå Workflow: How to Use with AI</h3>
                        <div class="space-y-3">
                            <div class="bg-slate-800/30 border border-slate-700 rounded-lg p-4">
                                <div class="font-medium text-slate-100 mb-2">üîÑ Option 1: Prompt Grok & Paste Code</div>
                                <ol class="text-xs text-slate-400 space-y-1 ml-4 list-decimal">
                                    <li>Describe drawing above</li>
                                    <li>Click "Copy Prompt for Grok"</li>
                                    <li>Paste into grok.x.ai</li>
                                    <li>Grok returns SVG</li>
                                    <li>Paste in CODE tab ‚Üí LOAD CODE</li>
                                </ol>
                            </div>
                            <div class="bg-slate-800/30 border border-slate-700 rounded-lg p-4">
                                <div class="font-medium text-slate-100 mb-2">‚ö° Option 2: Direct Link (Fastest)</div>
                                <ol class="text-xs text-slate-400 space-y-1 ml-4 list-decimal">
                                    <li>Click "Copy Link for AI"</li>
                                    <li>Paste link + description into any AI</li>
                                    <li>AI opens vibedraft and builds it</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-base font-semibold text-blue-400 uppercase tracking-wider mb-4">üéØ Pro Tips</h3>
                        <ul class="text-xs text-slate-400 space-y-2">
                            <li><span class="text-blue-400">1.</span> Be specific with exact dimensions and features</li>
                            <li><span class="text-blue-400">2.</span> Start from a TEMPLATES tab frame</li>
                            <li><span class="text-blue-400">3.</span> Ask for leaders, notes, and clean dimensioning</li>
                            <li><span class="text-blue-400">4.</span> Use Option 2 (direct link) for fastest results</li>
                            <li><span class="text-blue-400">5.</span> Iterate: "Refine the previous drawing..."</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- TEMPLATES -->
            <div id="rules-panel" class="flex-1 hidden flex-col p-8 bg-slate-900/50 backdrop-blur overflow-y-auto">
                <div class="max-w-5xl mx-auto w-full space-y-10">
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2">Clean Frame Templates</h2>
                        <p class="text-slate-400 mb-8">Choose version with or without reserved title block space at bottom.</p>

                        <div class="template-grid">
                            <button onclick="insertTemplate('a_letter_with')" class="template-button">
                                <div class="text-sm font-semibold text-slate-100">A Size ‚Äì with title block</div>
                                <div class="text-xs text-slate-400 mt-1">1056 √ó 816 px</div>
                            </button>
                            <button onclick="insertTemplate('a_letter_no')" class="template-button">
                                <div class="text-sm font-semibold text-slate-100">A Size ‚Äì no title block</div>
                                <div class="text-xs text-slate-400 mt-1">1056 √ó 816 px</div>
                            </button>

                            <button onclick="insertTemplate('b_tabloid_with')" class="template-button">
                                <div class="text-sm font-semibold text-slate-100">B Size ‚Äì with title block</div>
                                <div class="text-xs text-slate-400 mt-1">1632 √ó 1056 px</div>
                            </button>
                            <button onclick="insertTemplate('b_tabloid_no')" class="template-button">
                                <div class="text-sm font-semibold text-slate-100">B Size ‚Äì no title block</div>
                                <div class="text-xs text-slate-400 mt-1">1632 √ó 1056 px</div>
                            </button>

                            <button onclick="insertTemplate('d_arch_with')" class="template-button">
                                <div class="text-sm font-semibold text-slate-100">D Size ‚Äì with title block</div>
                                <div class="text-xs text-slate-400 mt-1">3456 √ó 2304 px</div>
                            </button>
                            <button onclick="insertTemplate('d_arch_no')" class="template-button">
                                <div class="text-sm font-semibold text-slate-100">D Size ‚Äì no title block</div>
                                <div class="text-xs text-slate-400 mt-1">3456 √ó 2304 px</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="h-10 bg-slate-900/50 backdrop-blur border-t border-slate-700/50 px-8 flex items-center justify-between text-[11px] text-slate-500 font-mono">
        <div class="flex-1">vibedraft v0.6</div>
    </div>

    <script>
        tailwind.config = { content: [] };

        let currentSVG = '', currentUnits = 'inches', zoomLevel = 1, isDragging = false, startPanX = 0, startPanY = 0, currentLogo = '';
        let includeTitleBlock = true;

        const PaperSizes = {
            letter:  { landscape: {w:1056, h:816},  portrait: {w:816, h:1056} },
            tabloid: { landscape: {w:1632, h:1056}, portrait: {w:1056, h:1632} },
            arch_d:  { landscape: {w:3456, h:2304}, portrait: {w:2304, h:3456} },
            custom:  { landscape: {w:1056, h:816},  portrait: {w:816, h:1056} }
        };

        const TitleBlockHeight = {
            letter:  140,
            tabloid: 220,
            arch_d:  480,
            custom:  140
        };

        function getCurrentOrientation() {
            return document.getElementById('meta-orientation')?.value || 'landscape';
        }

        function toggleTitleBlock() {
            includeTitleBlock = document.getElementById('include-title-block').checked;
            const fields = document.querySelectorAll('#project-info-section input, #project-info-section select');
            fields.forEach(el => el.disabled = !includeTitleBlock);

            updatePaperDimensions();
            renderViewer();
        }

        function updatePaperDimensions() {
            const sizeKey = document.getElementById('paper-size')?.value || 'letter';
            const ori = getCurrentOrientation();
            let dims = PaperSizes[sizeKey]?.[ori] || PaperSizes.letter.landscape;

            if (!includeTitleBlock) {
                // Full height when title block is disabled
                dims = { w: dims.w, h: dims.h };
            } else {
                // Reserve space at bottom for title block
                const tbHeight = TitleBlockHeight[sizeKey] || 140;
                dims = { w: dims.w, h: dims.h - tbHeight };
            }

            document.getElementById('paper-width').value = dims.w;
            document.getElementById('paper-height').value = dims.h;

            updateSVGSize();
            renderViewer();
        }

        function uploadLogo() {
            const input = document.getElementById('logo-upload');
            if (!input.files?.[0]) return;
            const reader = new FileReader();
            reader.onload = e => {
                currentLogo = e.target.result;
                document.getElementById('logo-preview').innerHTML = `<img src="${currentLogo}" style="max-height:100%;max-width:100%;object-fit:contain;">`;
                if (includeTitleBlock) renderTitleBlock();
            };
            reader.readAsDataURL(input.files[0]);
        }

        function validateRequired() {
            if (!includeTitleBlock) return true;
            const title = document.getElementById('meta-title')?.value?.trim();
            const dwg = document.getElementById('meta-dwg')?.value?.trim();
            const rev = document.getElementById('meta-rev')?.value?.trim();
            if (!title || !dwg || !rev) {
                alert('‚ö†Ô∏è Title, Drawing Number, and Revision are required when title block is enabled.');
                return false;
            }
            return true;
        }

        function updateSVGSize() {
            const w = parseFloat(document.getElementById('paper-width')?.value) || 1056;
            const h = parseFloat(document.getElementById('paper-height')?.value) || 816;
            const container = document.getElementById('svg-container');
            const svg = container?.querySelector('svg');
            if (svg) {
                svg.setAttribute('width', w);
                svg.setAttribute('height', h);
                svg.style.width = `${w}px`;
                svg.style.height = `${h}px`;
                svg.style.maxWidth = '100%';
                svg.style.maxHeight = '78vh';
            }
        }

        const SVGValidator = {
            errors: [],
            validate(s) {
                this.errors = [];
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(s, 'text/xml');
                    if (doc.getElementsByTagName('parsererror').length > 0) {
                        this.errors.push('Invalid XML structure');
                        return false;
                    }
                    return !!doc.querySelector('svg');
                } catch (e) {
                    this.errors.push(e.message);
                    return false;
                }
            }
        };

        const Templates = {
            a_letter_with: () => `<svg width="1056" height="676" viewBox="0 0 1056 676" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <rect x="32" y="32" width="992" height="612" rx="12" stroke="#111827" stroke-width="4"/>
</svg>`,

            a_letter_no: () => `<svg width="1056" height="816" viewBox="0 0 1056 816" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <rect x="32" y="32" width="992" height="752" rx="12" stroke="#111827" stroke-width="4"/>
</svg>`,

            b_tabloid_with: () => `<svg width="1632" height="836" viewBox="0 0 1632 836" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <rect x="44" y="44" width="1544" height="748" rx="16" stroke="#111827" stroke-width="4"/>
</svg>`,

            b_tabloid_no: () => `<svg width="1632" height="1056" viewBox="0 0 1632 1056" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <rect x="44" y="44" width="1544" height="968" rx="16" stroke="#111827" stroke-width="4"/>
</svg>`,

            d_arch_with: () => `<svg width="3456" height="1976" viewBox="0 0 3456 1976" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <rect x="88" y="88" width="3280" height="1800" rx="32" stroke="#111827" stroke-width="4"/>
</svg>`,

            d_arch_no: () => `<svg width="3456" height="2304" viewBox="0 0 3456 2304" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <rect x="88" y="88" width="3280" height="2128" rx="32" stroke="#111827" stroke-width="4"/>
</svg>`
        };

        function insertTemplate(name) {
            if (Templates[name]) {
                currentSVG = Templates[name]();
                renderViewer();
                switchTab(0);
            }
        }

        function renderViewer() {
            const c = document.getElementById('svg-container');
            if (c) c.innerHTML = currentSVG || '';
            updateSVGSize();

            const titleBlockEl = document.getElementById('title-block');
            if (titleBlockEl) {
                titleBlockEl.style.display = includeTitleBlock ? 'grid' : 'none';
            }

            if (includeTitleBlock) renderTitleBlock();
            const ta = document.getElementById('code-text');
            if (ta) ta.value = currentSVG;
        }

        function renderTitleBlock() {
            if (!includeTitleBlock) return;
            const t = document.getElementById('title-block');
            if (!t) return;

            const title  = document.getElementById('meta-title')?.value || 'Untitled Drawing';
            const dwg    = document.getElementById('meta-dwg')?.value || 'DWG-001';
            const rev    = document.getElementById('meta-rev')?.value || 'A';
            const mat    = document.getElementById('meta-material')?.value || '';
            const scale  = document.getElementById('meta-scale')?.value || '1:1';
            const drawn  = document.getElementById('meta-drawn-by')?.value || '‚Äî';
            let logoHtml = currentLogo ? `<img src="${currentLogo}" style="height:64px;object-fit:contain;"/>` : '';

            const w = parseFloat(document.getElementById('paper-width')?.value) || 1056;
            t.style.width = `${Math.min(w, window.innerWidth * 0.92)}px`;

            t.innerHTML = `
                <div class="col-span-12 flex justify-between items-start border-b border-slate-300 pb-5">
                    <div class="flex items-start gap-5">
                        <div>${logoHtml}</div>
                        <div>
                            <div class="text-4xl font-bold tracking-tight text-slate-900">${title}</div>
                            <div class="text-base text-slate-600 mt-1">${dwg} ‚Ä¢ REV ${rev}</div>
                        </div>
                    </div>
                    <div class="text-right text-sm text-slate-700">
                        <div>${mat}</div>
                        <div class="mt-1">${scale}</div>
                    </div>
                </div>
                <div class="col-span-12 text-xs pt-5 text-slate-600 grid grid-cols-3">
                    <div>DRAWN BY: ${drawn}</div>
                    <div class="text-center">DATE: ${new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div>
                    <div class="text-right">vibedraft</div>
                </div>`;
        }

        function switchTab(n) {
            document.querySelectorAll('[id^="tab-"]').forEach(b => { if (b) b.classList.remove('tab-active'); });
            const activeTab = document.getElementById(`tab-${n}`);
            if (activeTab) activeTab.classList.add('tab-active');

            const panels = ['viewer-panel','code-panel','three-panel','ai-panel','rules-panel'];
            panels.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            const toShow = document.getElementById(panels[n]);
            if (toShow) toShow.classList.remove('hidden');
        }

        function loadCodeFromTextarea() {
            const code = document.getElementById('code-text')?.value?.trim();
            if (!code) return alert('Paste SVG code first');
            if (SVGValidator.validate(code)) {
                extractAndApplyMetadata(code);
                currentSVG = code;
                renderViewer();
                switchTab(0);
                alert('‚úì Drawing loaded! Metadata auto-populated from comments.');
            } else {
                alert('‚ùå Invalid SVG:\n' + SVGValidator.errors.join('\n'));
            }
        }

        function extractAndApplyMetadata(code) {
            const patterns = {
                title:      /<!-- VIBEDRAFT_TITLE: (.*?) -->/,
                dwg:        /<!-- VIBEDRAFT_NUMBER: (.*?) -->/,
                rev:        /<!-- VIBEDRAFT_REVISION: (.*?) -->/,
                material:   /<!-- VIBEDRAFT_MATERIAL: (.*?) -->/,
                scale:      /<!-- VIBEDRAFT_SCALE: (.*?) -->/,
                drawnBy:    /<!-- VIBEDRAFT_DRAWN_BY: (.*?) -->/,
                orientation:/<!-- VIBEDRAFT_ORIENTATION: (.*?) -->/
            };
            for (const [key, regex] of Object.entries(patterns)) {
                const match = code.match(regex);
                if (match) {
                    const el = document.getElementById(key === 'dwg' ? 'meta-dwg' : `meta-${key}`);
                    if (el) el.value = match[1];
                }
            }
        }

        function getMetadataComments() {
            return `<!-- VIBEDRAFT_TITLE: ${document.getElementById('meta-title')?.value || ''} -->
<!-- VIBEDRAFT_NUMBER: ${document.getElementById('meta-dwg')?.value || ''} -->
<!-- VIBEDRAFT_REVISION: ${document.getElementById('meta-rev')?.value || ''} -->
<!-- VIBEDRAFT_MATERIAL: ${document.getElementById('meta-material')?.value || ''} -->
<!-- VIBEDRAFT_SCALE: ${document.getElementById('meta-scale')?.value || ''} -->
<!-- VIBEDRAFT_DRAWN_BY: ${document.getElementById('meta-drawn-by')?.value || ''} -->
<!-- VIBEDRAFT_ORIENTATION: ${document.getElementById('meta-orientation')?.value || ''} -->\n`;
        }

        function copyCodeWithMetadata() {
            if (!currentSVG) return alert('No drawing to copy');
            navigator.clipboard.writeText(getMetadataComments() + currentSVG);
            alert('‚úì Copied with metadata comments (auto-loads on paste)');
        }

        function copyCode() {
            if (!currentSVG) return alert('No drawing');
            navigator.clipboard.writeText(currentSVG);
            alert('‚úì SVG copied');
        }

        function copyAIPromptWithMetadata() {
            const desc = document.getElementById('ai-prompt')?.value?.trim();
            if (!desc) return alert('Describe your drawing first');
            const meta = getMetadataComments();
            const prompt = `Create a clean technical drawing in SVG format using the vibedraft tool.

CRITICAL: Include these exact metadata comments at the very top (before <svg>):
${meta}

DESCRIPTION:
${desc}

Use thin outer border matching the TEMPLATES tab style. Keep drawing area empty except for the actual geometry you create. Return ONLY the full SVG code.`;
            navigator.clipboard.writeText(prompt);
            alert('‚úì Prompt copied! Paste into Grok ‚Üí get SVG ‚Üí paste in CODE tab ‚Üí LOAD CODE');
        }

        function copyDirectLink() {
            const link = window.location.href;
            const desc = document.getElementById('ai-prompt')?.value?.trim() || "Create a technical drawing";
            const full = `Please open this vibedraft tool and create the drawing:

${link}

Request: ${desc}

1. Open link
2. Choose size from TEMPLATES tab
3. Fill sidebar metadata (if using title block)
4. Generate / paste drawing inside the frame
5. Export SVG or PDF

Thanks!`;
            navigator.clipboard.writeText(full);
            alert('‚úì Direct link + instructions copied!');
        }

        function copyGrokPrompt() {
            if (!currentSVG) return alert('Create or load a drawing first');
            const p = `Refine this technical drawing. Keep the thin outer border and metadata comments (if present). Improve layout, add proper dimensions and leaders. Return ONLY the updated SVG code.\n\n\`\`\`svg\n${currentSVG}\n\`\`\``;
            navigator.clipboard.writeText(p);
            alert('‚úì Refinement prompt copied');
        }

        function initThreeIfNeeded() {
            if (window.threeInitialized) return;
            window.threeInitialized = true;
            const canvas = document.getElementById('three-canvas');
            if (!canvas) return;
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth * 0.7, window.innerHeight * 0.8);
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1428);
            const camera = new THREE.PerspectiveCamera(45, 1.6, 10, 3000);
            camera.position.set(700, 500, 1000);
            const light = new THREE.DirectionalLight(0xffffff, 1.5);
            light.position.set(800, 1100, 900);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xaaaaaa));
            const box = new THREE.Mesh(new THREE.BoxGeometry(480, 140, 620), new THREE.MeshPhongMaterial({ color: 0x64748b }));
            scene.add(box);
            function animate() {
                requestAnimationFrame(animate);
                box.rotation.y += 0.0012;
                renderer.render(scene, camera);
            }
            animate();
        }

        function setUnits(n) {
            const inBtn = document.getElementById('unit-in');
            const mmBtn = document.getElementById('unit-mm');
            const label = document.getElementById('units-label');
            if (!inBtn || !mmBtn || !label) return;
            inBtn.classList.toggle('bg-blue-600', n === 0);
            inBtn.classList.toggle('text-white', n === 0);
            mmBtn.classList.toggle('bg-blue-600', n === 1);
            mmBtn.classList.toggle('text-white', n === 1);
            label.textContent = n === 0 ? 'INCHES' : 'MILLIMETERS';
            currentUnits = n === 0 ? 'inches' : 'mm';
        }

        function validateDrawing() {
            renderTitleBlock();
            alert('Metadata and viewport refreshed');
        }

        function validateAndShowErrors() {
            const code = document.getElementById('code-text')?.value;
            if (!code) return;
            const valid = SVGValidator.validate(code);
            const panel = document.getElementById('validation-panel');
            const output = document.getElementById('validation-output');
            if (valid) {
                output.innerHTML = '<div class="success-badge p-3 rounded">‚úì Valid SVG code</div>';
            } else {
                let html = '<div class="space-y-1">';
                SVGValidator.errors.forEach(e => html += `<div class="error-badge p-3 rounded text-xs">${e}</div>`);
                html += '</div>';
                output.innerHTML = html;
            }
            panel.classList.remove('hidden');
        }

        function newDrawing() {
            if (confirm('Start fresh? Current drawing will be replaced.')) {
                currentSVG = includeTitleBlock ? Templates.a_letter_with() : Templates.a_letter_no();
                renderViewer();
                switchTab(0);
            }
        }

        function saveDrawing() {
            if (includeTitleBlock && !validateRequired()) return;
            const data = {
                svg: currentSVG,
                logo: currentLogo,
                meta: {
                    title: document.getElementById('meta-title')?.value || '',
                    dwg: document.getElementById('meta-dwg')?.value || '',
                    rev: document.getElementById('meta-rev')?.value || '',
                    material: document.getElementById('meta-material')?.value || '',
                    scale: document.getElementById('meta-scale')?.value || '',
                    drawnBy: document.getElementById('meta-drawn-by')?.value || '',
                    orientation: document.getElementById('meta-orientation')?.value || 'landscape',
                    paperSize: document.getElementById('paper-size')?.value || 'letter',
                    includeTitleBlock: includeTitleBlock
                }
            };
            localStorage.setItem('vibedraft_current', JSON.stringify(data));
            alert('‚úì Drawing saved to browser storage');
        }

        function exportSVG() {
            if (includeTitleBlock && !validateRequired()) return;
            if (!currentSVG) return alert('No drawing to export');
            const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${document.getElementById('meta-dwg')?.value || 'drawing'}.svg`;
            a.click();
        }

        async function exportPDF() {
            if (includeTitleBlock && !validateRequired()) return alert('Missing required fields or no drawing');
            if (!currentSVG) return alert('No drawing to export');

            const orientation = document.getElementById('meta-orientation')?.value === 'landscape' ? 'l' : 'p';
            let sizeKey = document.getElementById('paper-size')?.value || 'letter';
            const { jsPDF } = window.jspdf;
            let pdf;

            if (sizeKey === 'arch_d') {
                pdf = new jsPDF(orientation, 'mm', [orientation === 'l' ? 914.4 : 609.6, orientation === 'l' ? 609.6 : 914.4]);
            } else {
                pdf = new jsPDF(orientation, 'mm', sizeKey === 'tabloid' ? 'tabloid' : 'letter');
            }

            const pageWidth  = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            let y = 12;

            // Metadata / title block area (only if enabled)
            if (includeTitleBlock) {
                if (currentLogo) {
                    const img = new Image();
                    img.src = currentLogo;
                    await new Promise(r => img.onload = r);

                    let logoW = 40;
                    let logoH = logoW * (img.height / img.width);
                    if (logoH > 25) {
                        logoH = 25;
                        logoW = logoH * (img.width / img.height);
                    }
                    pdf.addImage(img, 'PNG', (pageWidth - logoW) / 2, y, logoW, logoH);
                    y += logoH + 8;
                }

                pdf.setFontSize(20);
                pdf.text(document.getElementById('meta-title')?.value || 'Technical Drawing', pageWidth / 2, y, { align: 'center' });
                y += 10;
                pdf.setFontSize(11);
                pdf.text(`${document.getElementById('meta-dwg')?.value || '‚Äî'} ‚Ä¢ REV ${document.getElementById('meta-rev')?.value || '‚Äî'}`, pageWidth / 2, y, { align: 'center' });
                y += 12;

                pdf.setLineWidth(0.4);
                pdf.line(15, y, pageWidth - 15, y);
                y += 10;
            }

            // Drawing area
            const wrapper = document.getElementById('svg-wrapper');
            const canvas = await html2canvas(wrapper, {
                scale: 3,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true
            });
            const imgData = canvas.toDataURL('image/png');

            const drawAreaW = pageWidth - 30;
            const drawAreaH = pageHeight - y - 30;
            const imgRatio = canvas.width / canvas.height;
            let drawW = drawAreaW;
            let drawH = drawW / imgRatio;

            if (drawH > drawAreaH) {
                drawH = drawAreaH;
                drawW = drawH * imgRatio;
            }

            pdf.addImage(imgData, 'PNG', (pageWidth - drawW) / 2, y, drawW, drawH);

            pdf.save(`${document.getElementById('meta-dwg')?.value || 'drawing'}.pdf`);

            if (!localStorage.getItem('pdf-logo-hint-shown')) {
                alert('PDF exported!\n\nTip: For best logo clarity in PDF, use images ~120‚Äì200 px wide (vector/SVG logos work best).');
                localStorage.setItem('pdf-logo-hint-shown', 'true');
            }
        }

        function loadFromJSON() {
            const json = prompt('Paste saved JSON:');
            if (!json) return;
            try {
                const d = JSON.parse(json);
                if (d.svg) currentSVG = d.svg;
                if (d.logo) {
                    currentLogo = d.logo;
                    document.getElementById('logo-preview').innerHTML = `<img src="${currentLogo}" style="max-height:100%;max-width:100%;object-fit:contain;">`;
                }
                if (d.meta) {
                    ['title','dwg','rev','material','scale','drawnBy','orientation'].forEach(k => {
                        const el = document.getElementById(k === 'dwg' ? 'meta-dwg' : `meta-${k}`);
                        if (el && d.meta[k] !== undefined) el.value = d.meta[k];
                    });
                    if (d.meta.paperSize) {
                        document.getElementById('paper-size').value = d.meta.paperSize;
                    }
                    if (d.meta.includeTitleBlock !== undefined) {
                        includeTitleBlock = d.meta.includeTitleBlock;
                        document.getElementById('include-title-block').checked = includeTitleBlock;
                        toggleTitleBlock();
                    }
                }
                renderViewer();
                switchTab(0);
            } catch (e) {
                alert('Invalid JSON format');
            }
        }

        function clearAllData() {
            if (confirm('Clear all data and start fresh?')) {
                localStorage.removeItem('vibedraft_current');
                location.reload();
            }
        }

        function initializeApp() {
            lucide.createIcons();

            const saved = localStorage.getItem('vibedraft_current');
            if (saved) {
                try {
                    const d = JSON.parse(saved);
                    if (d.svg) currentSVG = d.svg;
                    if (d.logo) currentLogo = d.logo;
                    if (d.meta) {
                        ['title','dwg','rev','material','scale','drawnBy','orientation'].forEach(k => {
                            const el = document.getElementById(k === 'dwg' ? 'meta-dwg' : `meta-${k}`);
                            if (el && d.meta[k] !== undefined) el.value = d.meta[k];
                        });
                        if (d.meta.paperSize) {
                            document.getElementById('paper-size').value = d.meta.paperSize;
                        }
                        if (d.meta.includeTitleBlock !== undefined) {
                            includeTitleBlock = d.meta.includeTitleBlock;
                            document.getElementById('include-title-block').checked = includeTitleBlock;
                            toggleTitleBlock();
                        }
                    }
                } catch (_) {}
            } else {
                currentSVG = Templates.a_letter_with();
            }

            updatePaperDimensions();
            renderViewer();
            switchTab(0);
            setUnits(0);

            const wrapper = document.getElementById('svg-wrapper');
            if (wrapper) {
                wrapper.addEventListener('wheel', e => {
                    e.preventDefault();
                    zoomLevel = Math.max(0.4, Math.min(4, zoomLevel + e.deltaY * -0.0015));
                    wrapper.style.transform = `scale(${zoomLevel})`;
                });

                let panX = 0, panY = 0;
                wrapper.addEventListener('mousedown', e => {
                    if (e.button === 0) {
                        isDragging = true;
                        startPanX = e.clientX - panX;
                        startPanY = e.clientY - panY;
                    }
                });
                window.addEventListener('mousemove', e => {
                    if (!isDragging) return;
                    panX = e.clientX - startPanX;
                    panY = e.clientY - startPanY;
                    wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomLevel})`;
                });
                window.addEventListener('mouseup', () => isDragging = false);
            }
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
