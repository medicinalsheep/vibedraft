<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vibedraft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;family=Space+Grotesk:wght@500;600&amp;display=swap');

        .tail-container { font-family: 'Inter', system_ui, sans-serif; }
        .logo-font { font-family: 'Space Grotesk', sans-serif; }

        .viewer-svg {
            background: white;
            box-shadow: 0 25px 60px -15px rgb(0 0 0 / 0.5);
            border: 12px solid #1e2937;
            max-height: 78vh;
        }

        .title-block {
            background: #f8fafc;
            border: 3px solid #1e2937;
            font-size: 11px;
            line-height: 1.05;
            box-shadow: 0 10px 30px -10px rgb(0 0 0 / 0.3);
        }

        .tab-active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }

        .draft-tool.active {
            background: #3b82f6;
            color: white;
        }

        .error-badge {
            background: #dc2626;
            border: 1px solid #b91c1c;
            color: #fee2e2;
        }

        .success-badge {
            background: #059669;
            border: 1px solid #047857;
            color: #d1fae5;
        }

        .constraint-item {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .template-button {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-button:hover {
            background: #334155;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="tail-container bg-zinc-950 text-zinc-200 overflow-hidden h-screen flex flex-col">
    <!-- NAVBAR -->
    <nav class="bg-zinc-900 border-b border-zinc-800 px-8 py-4 flex items-center justify-between">
        <div class="flex items-center gap-x-12">
            <div class="flex items-center gap-x-3">
                <div class="w-9 h-9 bg-gradient-to-br from-blue-600 to-blue-500 rounded-2xl flex items-center justify-center text-white font-bold logo-font text-2xl shadow-inner">VD</div>
                <div>
                    <span class="logo-font text-3xl font-semibold tracking-[-2px]">VibeDraft</span>
                    <span class="ml-2 text-xs font-medium text-emerald-400 tracking-widest">v3.0 AI-PRO</span>
                </div>
            </div>
            
            <div class="flex gap-x-8 text-sm font-medium">
                <button onclick="switchTab(0)" id="tab-0" class="tab-active px-6 py-2">VIEWER</button>
                <button onclick="switchTab(1)" id="tab-1" class="px-6 py-2 hover:text-white transition">DRAFT</button>
                <button onclick="switchTab(2)" id="tab-2" class="px-6 py-2 hover:text-white transition">3D</button>
                <button onclick="switchTab(3)" id="tab-3" class="px-6 py-2 hover:text-white transition">CODE</button>
                <button onclick="switchTab(4)" id="tab-4" class="px-6 py-2 hover:text-white transition">RULES</button>
            </div>
        </div>
        
        <div class="flex items-center gap-x-6">
            <button onclick="newDrawing()" class="flex items-center gap-x-2 px-5 py-2.5 hover:bg-zinc-800 rounded-2xl transition">
                <i data-lucide="file-plus" class="w-5 h-5"></i>
                <span class="text-sm">New</span>
            </button>
            <button onclick="saveDrawing()" class="flex items-center gap-x-2 px-5 py-2.5 hover:bg-zinc-800 rounded-2xl transition">
                <i data-lucide="save" class="w-5 h-5"></i>
                <span class="text-sm">Save</span>
            </button>
            
            <div class="h-6 w-px bg-zinc-700"></div>
            
            <button onclick="exportSVG()" class="flex items-center gap-x-2 px-5 py-2.5 hover:bg-zinc-800 rounded-2xl transition">
                <i data-lucide="file-image" class="w-5 h-5"></i>
                <span class="text-sm">SVG</span>
            </button>
            <button onclick="exportPDF()" class="flex items-center gap-x-2 px-5 py-2.5 hover:bg-zinc-800 rounded-2xl transition">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span class="text-sm">PDF</span>
            </button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <!-- LEFT SETTINGS -->
        <div class="w-80 bg-zinc-900 border-r border-zinc-800 p-6 flex flex-col overflow-y-auto">
            <div class="uppercase text-xs tracking-widest text-zinc-500 mb-6">PROJECT METADATA</div>

            <div class="mb-4">
                <label class="text-xs text-zinc-400 block mb-2">Drawing Title</label>
                <input type="text" id="meta-title" value="BRACKET ASSEMBLY" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded text-sm text-zinc-200 focus:outline-none focus:border-blue-500">
            </div>
            <div class="mb-4">
                <label class="text-xs text-zinc-400 block mb-2">Drawing Number</label>
                <input type="text" id="meta-dwg" value="VD-2026-088" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded text-sm text-zinc-200 focus:outline-none focus:border-blue-500">
            </div>
            <div class="mb-4">
                <label class="text-xs text-zinc-400 block mb-2">Revision</label>
                <input type="text" id="meta-rev" value="C" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded text-sm text-zinc-200 focus:outline-none focus:border-blue-500">
            </div>
            <div class="mb-4">
                <label class="text-xs text-zinc-400 block mb-2">Material</label>
                <input type="text" id="meta-material" value="6061-T6 ALUMINUM" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded text-sm text-zinc-200 focus:outline-none focus:border-blue-500">
            </div>

            <div class="border-t border-zinc-700 my-4 pt-4">
                <div class="uppercase text-xs tracking-widest text-zinc-500 mb-4">STANDARDS</div>
                <div class="mb-4">
                    <label class="flex items-center gap-x-3 cursor-pointer">
                        <input type="checkbox" id="asme-check" checked class="w-4 h-4 accent-blue-600">
                        <div>
                            <div class="font-medium text-sm">ASME Y14.5-2018</div>
                            <div class="text-xs text-emerald-400">Compliant dimensioning</div>
                        </div>
                    </label>
                </div>
            </div>

            <div class="border-t border-zinc-700 my-4 pt-4">
                <div class="uppercase text-xs tracking-widest text-zinc-500 mb-4">UNITS & SCALE</div>
                <div class="mb-4">
                    <div class="flex items-center justify-between text-xs mb-2">
                        <span class="text-zinc-400">UNITS</span>
                        <span id="units-label" class="font-medium">INCHES</span>
                    </div>
                    <div class="flex bg-zinc-800 rounded p-1">
                        <button onclick="setUnits(0)" id="unit-in" class="flex-1 py-2 text-xs rounded font-medium active bg-zinc-700">INCHES</button>
                        <button onclick="setUnits(1)" id="unit-mm" class="flex-1 py-2 text-xs rounded font-medium">MM</button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="text-xs text-zinc-400 block mb-2">Scale (e.g., 1:1)</label>
                    <input type="text" id="meta-scale" value="1:1" class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded text-sm text-zinc-200 focus:outline-none focus:border-blue-500">
                </div>
            </div>

            <div class="mt-auto pt-6 border-t border-zinc-700">
                <button onclick="validateDrawing()" class="w-full py-2 px-3 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium mb-2">VALIDATE</button>
                <div class="text-[10px] leading-relaxed text-zinc-400">
                    VibeDraft v3.0 — AI-PRO edition optimized for Grok collaboration. Full JSON support, SVG validation, design rules, and templates.
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 flex flex-col">
            
            <!-- VIEWER TAB -->
            <div id="viewer-panel" class="flex-1 flex flex-col items-center justify-center bg-zinc-950 p-12 overflow-auto">
                <div id="svg-wrapper" class="relative cursor-grab active:cursor-grabbing">
                    <div id="svg-container" class="viewer-svg"></div>
                </div>
                
                <!-- TITLE BLOCK -->
                <div id="title-block" class="title-block mt-10 w-[820px] grid grid-cols-12 p-6 text-zinc-900">
                    <!-- JS filled -->
                </div>
            </div>
            
            <!-- DRAFT TAB -->
            <div id="draft-panel" class="flex-1 hidden flex-col bg-zinc-950">
                <div class="bg-zinc-900 border-b border-zinc-800 px-6 py-4 flex items-center gap-x-4">
                    <div class="flex items-center gap-x-2 bg-zinc-800 rounded p-1">
                        <button onclick="setDraftTool(0)" id="tool-select" class="draft-tool active w-10 h-10 flex items-center justify-center rounded" title="Select"><i data-lucide="mouse-pointer-2" class="w-5 h-5"></i></button>
                        <button onclick="setDraftTool(1)" id="tool-line" class="draft-tool w-10 h-10 flex items-center justify-center rounded" title="Line"><i data-lucide="minus" class="w-5 h-5"></i></button>
                        <button onclick="setDraftTool(2)" id="tool-rect" class="draft-tool w-10 h-10 flex items-center justify-center rounded" title="Rectangle"><i data-lucide="square" class="w-5 h-5"></i></button>
                        <button onclick="setDraftTool(3)" id="tool-circle" class="draft-tool w-10 h-10 flex items-center justify-center rounded" title="Circle"><i data-lucide="circle" class="w-5 h-5"></i></button>
                        <button onclick="setDraftTool(4)" id="tool-text" class="draft-tool w-10 h-10 flex items-center justify-center rounded" title="Text"><i data-lucide="type" class="w-5 h-5"></i></button>
                        <button onclick="setDraftTool(5)" id="tool-dimension" class="draft-tool w-10 h-10 flex items-center justify-center rounded" title="Dimension"><i data-lucide="ruler" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex-1"></div>
                    <div class="flex items-center gap-x-3">
                        <button onclick="deleteDraftElement()" class="px-3 py-1.5 bg-red-600/20 border border-red-600 rounded text-xs text-red-200 hover:bg-red-600/30">Delete Selected</button>
                        <button onclick="clearDraft()" class="px-3 py-1.5 bg-zinc-700 rounded text-xs hover:bg-zinc-600">Clear All</button>
                        <button onclick="exportDraftToSVG()" class="px-3 py-1.5 bg-blue-600 rounded text-xs hover:bg-blue-500">Export to Viewer</button>
                    </div>
                </div>
                <div class="flex-1 flex items-center justify-center bg-zinc-950 p-8">
                    <canvas id="fabric-canvas" width="920" height="620"></canvas>
                </div>
                <div class="bg-zinc-900 border-t border-zinc-800 px-6 py-3 text-xs text-zinc-400">
                    <span id="draft-status">Ready • Select a tool to start drawing</span>
                </div>
            </div>
            
            <!-- 3D TAB -->
            <div id="three-panel" class="flex-1 hidden bg-[#0a1428] relative">
                <canvas id="three-canvas" class="w-full h-full"></canvas>
            </div>
            
            <!-- CODE TAB -->
            <div id="code-panel" class="flex-1 hidden flex-col p-8 bg-zinc-900 overflow-hidden">
                <div class="max-w-6xl mx-auto w-full h-full flex flex-col">
                    <div class="text-lg font-medium mb-4 flex items-center gap-x-3">
                        <i data-lucide="code-2" class="w-6 h-6 text-blue-400"></i>
                        SVG CODE FOR GROK
                    </div>
                    <div class="flex gap-x-4 mb-4">
                        <button onclick="validateAndShowErrors()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded text-sm font-medium">VALIDATE SVG</button>
                        <button onclick="copyCode()" class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 rounded text-sm font-medium">COPY SVG</button>
                        <button onclick="copyGrokPrompt()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium">COPY GROK PROMPT</button>
                        <button onclick="loadFromJSON()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded text-sm font-medium">LOAD JSON</button>
                    </div>
                    <div id="validation-panel" class="hidden mb-4 p-4 rounded border border-yellow-600/50 bg-yellow-600/10">
                        <div class="font-medium text-yellow-400 mb-2">Validation Results</div>
                        <div id="validation-output" class="text-xs text-yellow-200"></div>
                    </div>
                    <textarea id="code-text" class="flex-1 bg-black border border-zinc-800 font-mono text-xs p-8 text-emerald-300 rounded resize-none focus:outline-none focus:border-blue-500"></textarea>
                    <div class="text-xs text-zinc-500 mt-4 text-center">
                        Paste SVG from Grok here → click VALIDATE to check → Export to VIEWER to see rendered drawing
                    </div>
                </div>
            </div>

            <!-- RULES TAB -->
            <div id="rules-panel" class="flex-1 hidden flex-col p-8 bg-zinc-900 overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full">
                    <div class="text-lg font-medium mb-6 flex items-center gap-x-3">
                        <i data-lucide="book-open" class="w-6 h-6 text-blue-400"></i>
                        DESIGN RULES & TEMPLATES
                    </div>

                    <div class="mb-8">
                        <h3 class="text-base font-medium mb-4 text-blue-400">ASME Y14.5-2018 Rules</h3>
                        <div class="space-y-3">
                            <div class="constraint-item">
                                <div class="font-medium text-sm">Dimensions must be HORIZONTAL or VERTICAL</div>
                                <div class="text-xs text-zinc-400 mt-1">Place all dimensions parallel to object edges or aligned in 90-degree angles</div>
                            </div>
                            <div class="constraint-item">
                                <div class="font-medium text-sm">Dimension lines use DASHED lines</div>
                                <div class="text-xs text-zinc-400 mt-1">Stroke pattern: stroke-dasharray="12 8"</div>
                            </div>
                            <div class="constraint-item">
                                <div class="font-medium text-sm">Dimension text must be READABLE</div>
                                <div class="text-xs text-zinc-400 mt-1">Font size minimum: 32px, bold weight: 600</div>
                            </div>
                            <div class="constraint-item">
                                <div class="font-medium text-sm">No SMALL negative angles or transforms</div>
                                <div class="text-xs text-zinc-400 mt-1">Use only positive coordinate values and standard rotations (0°, 90°, 180°, 270°)</div>
                            </div>
                            <div class="constraint-item">
                                <div class="font-medium text-sm">GD&amp;T symbols require DATUMS</div>
                                <div class="text-xs text-zinc-400 mt-1">Include A, B, C datum reference frames for geometric tolerances</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-base font-medium mb-4 text-emerald-400">Quick Templates</h3>
                        <div class="template-grid">
                            <button onclick="insertTemplate('simple_rect')" class="template-button">
                                <div class="text-xs font-medium">Simple Rect</div>
                                <div class="text-[10px] text-zinc-400 mt-1">Basic rectangle with dimensions</div>
                            </button>
                            <button onclick="insertTemplate('two_holes')" class="template-button">
                                <div class="text-xs font-medium">Two Holes</div>
                                <div class="text-[10px] text-zinc-400 mt-1">Rectangle with 2 circles + dims</div>
                            </button>
                            <button onclick="insertTemplate('bracket')" class="template-button">
                                <div class="text-xs font-medium">L-Bracket</div>
                                <div class="text-[10px] text-zinc-400 mt-1">Angular bracket with GD&amp;T</div>
                            </button>
                            <button onclick="insertTemplate('hole_pattern')" class="template-button">
                                <div class="text-xs font-medium">Hole Pattern</div>
                                <div class="text-[10px] text-zinc-400 mt-1">4-hole pattern with positions</div>
                            </button>
                            <button onclick="insertTemplate('profile_vert')" class="template-button">
                                <div class="text-xs font-medium">Profile Vert</div>
                                <div class="text-[10px] text-zinc-400 mt-1">Vertical profile tolerance</div>
                            </button>
                            <button onclick="insertTemplate('concentricity')" class="template-button">
                                <div class="text-xs font-medium">Concentricity</div>
                                <div class="text-[10px] text-zinc-400 mt-1">Concentric circles + datum</div>
                            </button>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-base font-medium mb-4 text-purple-400">Current Drawing Constraints</h3>
                        <div id="constraints-list" class="space-y-2">
                            <div class="text-xs text-zinc-400">No constraints defined yet. Add them via the DRAFT tab.</div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-base font-medium mb-4 text-orange-400">AI Prompting Tips</h3>
                        <div class="bg-zinc-800 border border-zinc-700 rounded p-4 text-xs text-zinc-300 leading-relaxed space-y-2">
                            <p>✓ <strong>Be specific:</strong> "Add 0.005" tolerance to the Ø0.500" hole"</p>
                            <p>✓ <strong>Reference standards:</strong> "Apply ASME Y14.5-2018 profile tolerance"</p>
                            <p>✓ <strong>Use technical terms:</strong> "Add perpendicularity control relative to datum A"</p>
                            <p>✓ <strong>Request improvements:</strong> "Improve dimensioning clarity and add missing GD&amp;T"</p>
                            <p>✓ <strong>Ask for validation:</strong> "Validate this drawing against ASME standards"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- STATUS BAR -->
    <div class="h-9 bg-zinc-900 border-t border-zinc-800 px-8 flex items-center text-[10px] text-zinc-500 font-mono">
        <div class="flex-1">VibeDraft v3.0 AI-PRO • ASME Y14.5 • Structured JSON • SVG Validator</div>
        <div class="text-emerald-400">Perfect for Grok collaboration on GitHub Pages</div>
    </div>

    <script>
        tailwind.config = { content: [] };

        let fabricCanvas;
        let currentSVG = '';
        let currentDrawingModel = null;
        let currentUnits = 'inches';
        let draftTool = 0;
        let drawingStarted = false;

        let zoomLevel = 1;
        let isDragging = false;
        let startPanX = 0, startPanY = 0;

        // SVG VALIDATOR
        const SVGValidator = {
            errors: [],
            validate: function(svgString) {
                this.errors = [];
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(svgString, 'text/xml');
                    if (doc.getElementsByTagName('parsererror').length > 0) {
                        this.errors.push('❌ PARSE ERROR: Invalid XML syntax');
                        return false;
                    }
                    const svg = doc.querySelector('svg');
                    if (!svg) { this.errors.push('❌ No <svg> root element found'); return false; }
                    if (!svg.getAttribute('viewBox')) { this.errors.push('⚠️ Missing viewBox attribute'); }
                    if (!svg.getAttribute('width')) { this.errors.push('⚠️ Missing width attribute'); }
                    if (!svg.getAttribute('height')) { this.errors.push('⚠️ Missing height attribute'); }

                    const rects = svg.querySelectorAll('rect');
                    rects.forEach(r => {
                        if (!r.hasAttribute('x') || !r.hasAttribute('y')) this.errors.push('⚠️ Rectangle missing x or y');
                        if (!r.hasAttribute('width') || !r.hasAttribute('height')) this.errors.push('⚠️ Rectangle missing width or height');
                    });

                    const circles = svg.querySelectorAll('circle');
                    circles.forEach(c => {
                        if (!c.hasAttribute('cx') || !c.hasAttribute('cy')) this.errors.push('⚠️ Circle missing cx or cy');
                        if (!c.hasAttribute('r')) this.errors.push('⚠️ Circle missing radius (r)');
                    });

                    const texts = svg.querySelectorAll('text');
                    texts.forEach(t => {
                        if (!t.getAttribute('font-size') || parseInt(t.getAttribute('font-size')) < 20) {
                            this.errors.push('⚠️ Text too small (min 20px recommended)');
                        }
                        if (t.getAttribute('font-weight') !== '600' && !t.getAttribute('font-weight')) {
                            this.errors.push('⚠️ Text not bold (font-weight: 600 recommended)');
                        }
                    });

                    const lines = svg.querySelectorAll('line');
                    lines.forEach(l => {
                        const isDashed = l.getAttribute('stroke-dasharray');
                        if (isDashed && isDashed !== '12 8') {
                            this.errors.push('⚠️ Non-standard dimension line: use stroke-dasharray="12 8"');
                        }
                    });

                    return this.errors.length === 0;
                } catch(e) {
                    this.errors.push('❌ ' + e.message);
                    return false;
                }
            }
        };

        // JSON DRAWING MODEL
        const DrawingModel = {
            create: function() {
                return {
                    meta: {
                        title: "BRACKET ASSEMBLY",
                        dwg: "VD-2026-088",
                        rev: "C",
                        material: "6061-T6 ALUMINUM",
                        scale: "1:1",
                        units: "inches",
                        asmeCompliant: true
                    },
                    geometry: [],
                    dimensions: [],
                    constraints: [],
                    gdt: []
                };
            },
            toSVG: function(model) {
                let svg = `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg">`;
                model.geometry.forEach(g => {
                    if (g.type === 'rectangle') {
                        svg += `<rect x="${g.x}" y="${g.y}" width="${g.width}" height="${g.height}" ${g.rx ? `rx="${g.rx}"` : ''} fill="${g.fill || '#f8fafc'}" stroke="${g.stroke || '#1e2937'}" stroke-width="${g.strokeWidth || 2}"/>`;
                    } else if (g.type === 'circle') {
                        svg += `<circle cx="${g.cx}" cy="${g.cy}" r="${g.r}" fill="${g.fill || 'none'}" stroke="${g.stroke || '#1e2937'}" stroke-width="${g.strokeWidth || 2}"/>`;
                    } else if (g.type === 'line') {
                        svg += `<line x1="${g.x1}" y1="${g.y1}" x2="${g.x2}" y2="${g.y2}" stroke="${g.stroke || '#64748b'}" stroke-width="${g.strokeWidth || 2}" ${g.dashed ? `stroke-dasharray="12 8"` : ''}/>`;
                    } else if (g.type === 'text') {
                        svg += `<text x="${g.x}" y="${g.y}" font-family="sans-serif" font-size="${g.size || 32}" fill="${g.fill || '#1e2937'}" text-anchor="middle" font-weight="600">${g.content}</text>`;
                    }
                });
                model.dimensions.forEach(d => {
                    if (d.type === 'horizontal') {
                        svg += `<line x1="${d.x1}" y1="${d.y1}" x2="${d.x2}" y2="${d.y2}" stroke="#64748b" stroke-width="6" stroke-dasharray="12 8"/>`;
                        svg += `<text x="${(d.x1 + d.x2) / 2}" y="${d.y1 + d.offset}" font-family="sans-serif" font-size="42" fill="#1e2937" text-anchor="middle" font-weight="600">${d.value}${d.unit || '"'}</text>`;
                    } else if (d.type === 'vertical') {
                        svg += `<line x1="${d.x1}" y1="${d.y1}" x2="${d.x2}" y2="${d.y2}" stroke="#64748b" stroke-width="6" stroke-dasharray="12 8"/>`;
                        svg += `<text x="${d.x1 - d.offset}" y="${(d.y1 + d.y2) / 2}" font-family="sans-serif" font-size="32" fill="#1e2937" text-anchor="middle" font-weight="600" transform="rotate(-90 ${d.x1 - d.offset} ${(d.y1 + d.y2) / 2})">${d.value}${d.unit || '"'}</text>`;
                    }
                });
                svg += `</svg>`;
                return svg;
            },
            fromSVG: function(svgString) {
                const model = this.create();
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(svgString, 'text/xml');
                    const svg = doc.querySelector('svg');
                    if (!svg) return null;

                    doc.querySelectorAll('rect').forEach(r => {
                        model.geometry.push({
                            type: 'rectangle',
                            x: parseFloat(r.getAttribute('x')),
                            y: parseFloat(r.getAttribute('y')),
                            width: parseFloat(r.getAttribute('width')),
                            height: parseFloat(r.getAttribute('height')),
                            rx: r.getAttribute('rx') ? parseFloat(r.getAttribute('rx')) : null,
                            fill: r.getAttribute('fill'),
                            stroke: r.getAttribute('stroke'),
                            strokeWidth: r.getAttribute('stroke-width')
                        });
                    });

                    doc.querySelectorAll('circle').forEach(c => {
                        model.geometry.push({
                            type: 'circle',
                            cx: parseFloat(c.getAttribute('cx')),
                            cy: parseFloat(c.getAttribute('cy')),
                            r: parseFloat(c.getAttribute('r')),
                            fill: c.getAttribute('fill'),
                            stroke: c.getAttribute('stroke'),
                            strokeWidth: c.getAttribute('stroke-width')
                        });
                    });
                } catch(e) {
                    console.error('Error parsing SVG to model:', e);
                    return null;
                }
                return model;
            }
        };

        // TEMPLATES LIBRARY
        const Templates = {
            simple_rect: function() {
                return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="110" y="90" width="600" height="400" rx="20" fill="#f8fafc" stroke="#1e2937" stroke-width="28"/>
                    <line x1="80" y1="90" x2="80" y2="490" stroke="#64748b" stroke-width="6" stroke-dasharray="12 8"/>
                    <line x1="710" y1="90" x2="710" y2="490" stroke="#64748b" stroke-width="6" stroke-dasharray="12 8"/>
                    <text x="50" y="300" font-family="sans-serif" font-size="32" fill="#1e2937" text-anchor="middle" font-weight="600" transform="rotate(-90 50 300)">4.50"</text>
                    <line x1="110" y1="510" x2="710" y2="510" stroke="#64748b" stroke-width="6" stroke-dasharray="12 8"/>
                    <text x="410" y="545" font-family="sans-serif" font-size="42" fill="#1e2937" text-anchor="middle" font-weight="600">6.00"</text>
                </svg>`;
            },
            two_holes: function() {
                return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="110" y="90" width="600" height="400" rx="20" fill="#f8fafc" stroke="#1e2937" stroke-width="28"/>
                    <circle cx="310" cy="290" r="55" fill="none" stroke="#1e2937" stroke-width="16"/>
                    <circle cx="510" cy="290" r="55" fill="none" stroke="#1e2937" stroke-width="16"/>
                    <line x1="210" y1="270" x2="610" y2="270" stroke="#64748b" stroke-width="6" stroke-dasharray="12 8"/>
                    <text x="410" y="250" font-family="sans-serif" font-size="42" fill="#1e2937" text-anchor="middle" font-weight="600">8.00" (center-to-center)</text>
                    <text x="310" y="380" font-family="sans-serif" font-size="32" fill="#1e2937" text-anchor="middle" font-weight="600">Ø1.10"</text>
                    <text x="510" y="380" font-family="sans-serif" font-size="32" fill="#1e2937" text-anchor="middle" font-weight="600">Ø1.10"</text>
                </svg>`;
            },
            bracket: function() {
                return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M 150 250 L 150 150 L 450 150 L 450 250 L 300 250 L 300 350 L 150 350 Z" fill="#f8fafc" stroke="#1e2937" stroke-width="24"/>
                    <text x="410" y="520" font-family="sans-serif" font-size="32" fill="#1e2937" text-anchor="middle" font-weight="600">L-BRACKET TEMPLATE</text>
                </svg>`;
            },
            hole_pattern: function() {
                return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="110" y="90" width="600" height="400" rx="20" fill="#f8fafc" stroke="#1e2937" stroke-width="28"/>
                    <circle cx="210" cy="190" r="35" fill="none" stroke="#1e2937" stroke-width="12"/>
                    <circle cx="610" cy="190" r="35" fill="none" stroke="#1e2937" stroke-width="12"/>
                    <circle cx="210" cy="390" r="35" fill="none" stroke="#1e2937" stroke-width="12"/>
                    <circle cx="610" cy="390" r="35" fill="none" stroke="#1e2937" stroke-width="12"/>
                    <text x="410" y="520" font-family="sans-serif" font-size="32" fill="#1e2937" text-anchor="middle" font-weight="600">4-HOLE PATTERN</text>
                </svg>`;
            },
            profile_vert: function() {
                return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="150" y="150" width="520" height="300" rx="15" fill="#f8fafc" stroke="#1e2937" stroke-width="28"/>
                    <text x="410" y="320" font-family="sans-serif" font-size="48" fill="#1e2937" text-anchor="middle" font-weight="600">⬚ 0.005 A|B</text>
                    <text x="410" y="520" font-family="sans-serif" font-size="28" fill="#1e2937" text-anchor="middle" font-weight="600">PROFILE OF VERTICAL SURFACE</text>
                </svg>`;
            },
            concentricity: function() {
                return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="410" cy="290" r="120" fill="none" stroke="#1e2937" stroke-width="20"/>
                    <circle cx="410" cy="290" r="70" fill="none" stroke="#1e2937" stroke-width="16"/>
                    <text x="410" y="430" font-family="sans-serif" font-size="32" fill="#1e2937" text-anchor="middle" font-weight="600">⊙ 0.002 A</text>
                    <text x="410" y="520" font-family="sans-serif" font-size="28" fill="#1e2937" text-anchor="middle" font-weight="600">CONCENTRICITY</text>
                </svg>`;
            }
        };

        function insertTemplate(templateName) {
            if (Templates[templateName]) {
                currentSVG = Templates[templateName]();
                renderViewer();
                switchTab(0);
            }
        }

        function loadDemoSVG() {
            currentSVG = Templates.two_holes();
            currentDrawingModel = DrawingModel.fromSVG(currentSVG);
            renderViewer();
        }

        function renderViewer() {
            const container = document.getElementById('svg-container');
            container.innerHTML = currentSVG;
            const svgEl = container.querySelector('svg');
            if (svgEl) {
                svgEl.style.width = '820px';
                svgEl.style.height = '580px';
            }
            renderTitleBlock();
            updateCodePanel();
        }

        function renderTitleBlock() {
            const tb = document.getElementById('title-block');
            const title = document.getElementById('meta-title').value;
            const dwg = document.getElementById('meta-dwg').value;
            const rev = document.getElementById('meta-rev').value;
            const material = document.getElementById('meta-material').value;
            const scale = document.getElementById('meta-scale').value;

            tb.innerHTML = `
                <div class="col-span-12 flex justify-between items-start border-b border-zinc-900 pb-4">
                    <div>
                        <div class="text-3xl font-semibold tracking-tighter text-zinc-900">${title}</div>
                        <div class="text-sm text-zinc-500 mt-1">${dwg} • REV ${rev}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs leading-none">${material}</div>
                        <div class="text-xs mt-4">${scale}</div>
                    </div>
                </div>
                <div class="col-span-12 text-[10px] pt-4 text-zinc-600 grid grid-cols-3">
                    <div>DRAWN BY: GROK + VIBEDRAFT</div>
                    <div class="text-center">DATE: ${new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'})}</div>
                    <div class="text-right">ASME Y14.5-2018 COMPLIANT</div>
                </div>
            `;
        }

        function switchTab(n) {
            document.querySelectorAll('[id^="tab-"]').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab-${n}`).classList.add('tab-active');

            document.getElementById('viewer-panel').classList.add('hidden');
            document.getElementById('draft-panel').classList.add('hidden');
            document.getElementById('three-panel').classList.add('hidden');
            document.getElementById('code-panel').classList.add('hidden');
            document.getElementById('rules-panel').classList.add('hidden');

            if (n === 0) document.getElementById('viewer-panel').classList.remove('hidden');
            if (n === 1) { document.getElementById('draft-panel').classList.remove('hidden'); initFabricIfNeeded(); }
            if (n === 2) { document.getElementById('three-panel').classList.remove('hidden'); initThreeIfNeeded(); }
            if (n === 3) { 
                document.getElementById('code-panel').classList.remove('hidden');
                updateCodePanel();
            }
            if (n === 4) { document.getElementById('rules-panel').classList.remove('hidden'); }
        }

        function updateCodePanel() {
            document.getElementById('code-text').value = currentSVG || 'No drawing yet';
        }

        function initFabricIfNeeded() {
            if (fabricCanvas) return;
            fabricCanvas = new fabric.Canvas('fabric-canvas', { width: 920, height: 620, backgroundColor: '#f8fafc' });
            const r = new fabric.Rect({left:160, top:140, width:600, height:340, fill:'transparent', stroke:'#1e2937', strokeWidth:22});
            fabricCanvas.add(r);
            fabricCanvas.renderAll();
            updateDraftStatus('Ready to draw • Select a tool');
        }

        function setDraftTool(n) {
            draftTool = n;
            document.querySelectorAll('.draft-tool').forEach((t, i) => {
                t.classList.toggle('active', i === n);
            });
            const tools = ['Select', 'Line', 'Rectangle', 'Circle', 'Text', 'Dimension'];
            updateDraftStatus(`${tools[n]} tool selected`);
        }

        function updateDraftStatus(msg) {
            document.getElementById('draft-status').textContent = msg;
        }

        function deleteDraftElement() {
            if (fabricCanvas && fabricCanvas.getActiveObject()) {
                fabricCanvas.remove(fabricCanvas.getActiveObject());
                fabricCanvas.renderAll();
                updateDraftStatus('Element deleted');
            }
        }

        function clearDraft() {
            if (confirm('Clear all draft elements?')) {
                fabricCanvas.clear();
                updateDraftStatus('Canvas cleared');
            }
        }

        function exportDraftToSVG() {
            currentSVG = fabricCanvas.toSVG();
            renderViewer();
            switchTab(0);
            updateDraftStatus('Exported to Viewer ✓');
        }

        function initThreeIfNeeded() {
            if (window.threeInitialized) return;
            window.threeInitialized = true;
            const canvas = document.getElementById('three-canvas');
            const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
            renderer.setSize(1200, 700);
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1428);
            const camera = new THREE.PerspectiveCamera(45, 1200/700, 10, 2000);
            camera.position.set(500,400,800);
            const light = new THREE.DirectionalLight(0xffffff, 1.4);
            light.position.set(600,900,700);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xaaaaaa));
            const box = new THREE.Mesh(new THREE.BoxGeometry(420,120,520), new THREE.MeshPhongMaterial({color:0x64748b}));
            scene.add(box);
            function anim() {
                requestAnimationFrame(anim);
                box.rotation.y += 0.0015;
                renderer.render(scene, camera);
            }
            anim();
        }

        function setUnits(n) {
            document.getElementById('unit-in').classList.toggle('active', n===0);
            document.getElementById('unit-mm').classList.toggle('active', n===1);
            document.getElementById('units-label').textContent = n===0 ? 'INCHES' : 'MILLIMETERS';
            currentUnits = n===0 ? 'inches' : 'mm';
        }

        function validateDrawing() {
            renderTitleBlock();
            alert('✓ Metadata validated. Use VALIDATE SVG in CODE tab to check drawing structure.');
        }

        function validateAndShowErrors() {
            const svg = document.getElementById('code-text').value;
            const isValid = SVGValidator.validate(svg);
            const panel = document.getElementById('validation-panel');
            const output = document.getElementById('validation-output');

            if (isValid) {
                output.innerHTML = '<div class="success-badge p-2 rounded">✓ SVG is valid and ASME-compliant!</div>';
            } else {
                let html = '<div class="space-y-1">';
                SVGValidator.errors.forEach(err => {
                    html += `<div class="error-badge p-2 rounded text-xs">${err}</div>`;
                });
                html += '</div>';
                output.innerHTML = html;
            }
            panel.classList.remove('hidden');
        }

        function newDrawing() {
            if (confirm('Start fresh drawing?')) {
                currentSVG = Templates.simple_rect();
                renderViewer();
                switchTab(0);
            }
        }

        function saveDrawing() {
            const data = {
                svg: currentSVG,
                meta: {
                    title: document.getElementById('meta-title').value,
                    dwg: document.getElementById('meta-dwg').value,
                    rev: document.getElementById('meta-rev').value,
                    material: document.getElementById('meta-material').value,
                    scale: document.getElementById('meta-scale').value,
                    units: currentUnits
                },
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('vibedraft_current', JSON.stringify(data));
            alert('✓ Drawing + metadata saved to browser storage');
        }

        function exportSVG() {
            const blob = new Blob([currentSVG], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vibedraft_drawing.svg';
            a.click();
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const container = document.getElementById('svg-wrapper');
            const canvas = await html2canvas(container, {scale: 3});
            doc.addImage(canvas.toDataURL('image/png'), 'PNG', 15, 20, 180, 130);
            doc.save('vibedraft_drawing.pdf');
        }

        function copyCode() {
            navigator.clipboard.writeText(currentSVG);
            alert('✓ SVG code copied to clipboard');
        }

        function copyGrokPrompt() {
            const prompt = `# VibeDraft Professional Drawing Request\nHere is my current ASME Y14.5-2018 drawing (${currentUnits}, 3rd angle projection):\n\`\`\`svg\n${currentSVG}\n\`\`\`\n\n## Request:\nPlease refine this drawing with:\n- Better dimensioning and GD&T symbols\n- Proper ASME Y14.5 compliance\n- Clear tolerance callouts\n- Datum references where needed\n\nReturn ONLY the updated SVG code (no explanations).`;
            navigator.clipboard.writeText(prompt);
            alert('✓ Grok prompt copied — paste into grok.x.ai');
        }

        function loadFromJSON() {
            const jsonInput = prompt('Paste JSON drawing data:');
            if (!jsonInput) return;
            try {
                const data = JSON.parse(jsonInput);
                if (data.svg) {
                    currentSVG = data.svg;
                    if (data.meta) {
                        document.getElementById('meta-title').value = data.meta.title || 'DRAWING';
                        document.getElementById('meta-dwg').value = data.meta.dwg || 'VD-001';
                        document.getElementById('meta-rev').value = data.meta.rev || 'A';
                        document.getElementById('meta-material').value = data.meta.material || 'STEEL';
                        document.getElementById('meta-scale').value = data.meta.scale || '1:1';
                    }
                    renderViewer();
                    switchTab(0);
                } else {
                    alert('❌ JSON must contain an "svg" field');
                }
            } catch(e) {
                alert('❌ Invalid JSON: ' + e.message);
            }
        }

        function initializeApp() {
            lucide.createIcons();
            loadDemoSVG();
            switchTab(0);
            setUnits(0);

            // Viewer zoom & pan
            const wrapper = document.getElementById('svg-wrapper');
            wrapper.addEventListener('wheel', e => {
                e.preventDefault();
                zoomLevel += e.deltaY * -0.001;
                zoomLevel = Math.max(0.5, Math.min(3, zoomLevel));
                wrapper.style.transform = `scale(${zoomLevel})`;
            });

            wrapper.addEventListener('mousedown', e => {
                if (e.button === 0) {
                    isDragging = true;
                    startPanX = e.clientX;
                    startPanY = e.clientY;
                }
            });
            window.addEventListener('mousemove', e => {
                if (!isDragging) return;
                const dx = e.clientX - startPanX;
                const dy = e.clientY - startPanY;
                wrapper.style.transform = `translate(${dx}px, ${dy}px) scale(${zoomLevel})`;
            });
            window.addEventListener('mouseup', () => isDragging = false);

            // Load saved drawing
            const saved = localStorage.getItem('vibedraft_current');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    currentSVG = data.svg;
                    if (data.meta) {
                        document.getElementById('meta-title').value = data.meta.title;
                        document.getElementById('meta-dwg').value = data.meta.dwg;
                        document.getElementById('meta-rev').value = data.meta.rev;
                        document.getElementById('meta-material').value = data.meta.material;
                        document.getElementById('meta-scale').value = data.meta.scale;
                    }
                    renderViewer();
                } catch(e) {
                    console.log('Using demo drawing');
                }
            }

            console.log('%cvibedraft v0.1 — Full JSON model, SVG validator, templates, and Grok integration ready!', 'color:#3b82f6;font-family:monospace;font-size:14px;font-weight:bold');
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
