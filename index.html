<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vibedraft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@600&display=swap');

        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .tail-container {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1a1f3a 100%);
        }

        .logo-font {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -1px;
        }

        .viewer-svg {
            background: #fafbfc;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            max-height: 78vh;
        }

        .title-block {
            background: linear-gradient(to bottom, #f8fafc, #f0f4f8);
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 11px;
            line-height: 1.05;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .tab-active {
            border-bottom: 2px solid #60a5fa;
            color: #60a5fa;
            font-weight: 600;
        }

        .error-badge {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            border-radius: 6px;
        }

        .success-badge {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
            border-radius: 6px;
        }

        .constraint-item {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 0.75rem;
        }

        .template-button {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
        }

        .template-button:hover {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            border-color: #60a5fa;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(96, 165, 250, 0.2);
        }

        input, textarea, select {
            transition: all 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
        }
    </style>
</head>
<body class="tail-container text-slate-100 overflow-hidden h-screen flex flex-col">
    <nav class="bg-slate-900/50 backdrop-blur border-b border-slate-700/50 px-8 py-4 flex items-center justify-between">
        <div class="flex items-center gap-x-12">
            <div class="flex items-center gap-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center text-white font-bold logo-font text-lg shadow-lg">VD</div>
                <div>
                    <h1 class="logo-font text-3xl font-bold tracking-tight text-white">vibedraft</h1>
                    <span class="text-xs font-medium text-cyan-400">v0.2</span>
                </div>
            </div>
            <div class="flex gap-x-8 text-sm font-medium">
                <button onclick="switchTab(0)" id="tab-0" class="tab-active px-4 py-2 transition-colors duration-200 text-slate-300 hover:text-white">VIEWER</button>
                <button onclick="switchTab(1)" id="tab-1" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">CODE</button>
                <button onclick="switchTab(2)" id="tab-2" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">3D</button>
                <button onclick="switchTab(3)" id="tab-3" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">AI</button>
                <button onclick="switchTab(4)" id="tab-4" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">RULES</button>
            </div>
        </div>
        <div class="flex items-center gap-x-3">
            <button onclick="newDrawing()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/50 transition-colors duration-200 text-slate-300 hover:text-white">
                <i data-lucide="file-plus" class="w-4 h-4"></i>
                <span class="text-xs font-medium">New</span>
            </button>
            <button onclick="saveDrawing()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/50 transition-colors duration-200 text-slate-300 hover:text-white">
                <i data-lucide="save" class="w-4 h-4"></i>
                <span class="text-xs font-medium">Save</span>
            </button>
            <div class="w-px h-6 bg-slate-700/50"></div>
            <button onclick="exportSVG()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-blue-600/10 hover:bg-blue-600/20 transition-colors duration-200 text-blue-400 hover:text-blue-300">
                <i data-lucide="file-image" class="w-4 h-4"></i>
                <span class="text-xs font-medium">SVG</span>
            </button>
            <button onclick="exportPDF()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-blue-600/10 hover:bg-blue-600/20 transition-colors duration-200 text-blue-400 hover:text-blue-300">
                <i data-lucide="file-text" class="w-4 h-4"></i>
                <span class="text-xs font-medium">PDF</span>
            </button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR -->
        <div class="w-80 bg-slate-900/30 backdrop-blur border-r border-slate-700/50 p-8 flex flex-col overflow-y-auto space-y-6">
            <!-- Project Info -->
            <div>
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Project Info</div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Company Logo</label>
                        <label class="block">
                            <div class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-xs text-slate-400 hover:border-blue-500 cursor-pointer transition-colors text-center">
                                üì∑ Upload Logo
                            </div>
                            <input type="file" id="logo-upload" accept="image/*" onchange="uploadLogo()" style="display:none;">
                        </label>
                        <div id="logo-preview" class="mt-2 h-12 bg-slate-800/50 border border-slate-700 rounded-lg flex items-center justify-center text-xs text-slate-500"></div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Drawing Title <span class="text-red-400">*</span></label>
                        <input type="text" id="meta-title" value="" onchange="validateRequired()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Drawing Number <span class="text-red-400">*</span></label>
                        <input type="text" id="meta-dwg" value="" onchange="validateRequired()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Revision <span class="text-red-400">*</span></label>
                        <input type="text" id="meta-rev" value="A" onchange="validateRequired()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Material</label>
                        <input type="text" id="meta-material" value="" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Drawn By</label>
                        <input type="text" id="meta-drawn-by" value="" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Orientation</label>
                        <select id="meta-orientation" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                            <option value="landscape">Landscape</option>
                            <option value="portrait">Portrait</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Drawing Format -->
            <div class="border-t border-slate-700/30 pt-6">
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Drawing Format</div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Paper Size</label>
                        <select id="paper-size" onchange="changePaperSize()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                            <option value="letter">Letter (8.5 √ó 11")</option>
                            <option value="tabloid">Tabloid (11 √ó 17")</option>
                            <option value="A4">A4 (210 √ó 297 mm)</option>
                            <option value="A3">A3 (297 √ó 420 mm)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-slate-400 font-medium block mb-2">Width (px)</label>
                            <input type="number" id="paper-width" value="820" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 font-medium block mb-2">Height (px)</label>
                            <input type="number" id="paper-height" value="580" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Units & Scale -->
            <div class="border-t border-slate-700/30 pt-6">
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Units & Scale</div>
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between text-xs mb-3">
                            <span class="text-slate-400 font-medium">Unit System</span>
                            <span id="units-label" class="font-semibold text-blue-400">INCHES</span>
                        </div>
                        <div class="flex bg-slate-800/50 rounded-lg p-1 border border-slate-700">
                            <button onclick="setUnits(0)" id="unit-in" class="flex-1 py-2 text-xs rounded-md font-semibold bg-blue-600 text-white">INCHES</button>
                            <button onclick="setUnits(1)" id="unit-mm" class="flex-1 py-2 text-xs rounded-md font-semibold text-slate-400 hover:text-slate-100">MM</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Scale</label>
                        <input type="text" id="meta-scale" value="1:1" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="border-t border-slate-700/30 pt-6 mt-auto">
                <button onclick="validateDrawing()" class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 rounded-lg text-sm font-semibold text-white transition-all duration-200 shadow-lg hover:shadow-xl">
                    VALIDATE &amp; REFRESH
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 flex flex-col bg-slate-950/50">
            <!-- VIEWER -->
            <div id="viewer-panel" class="flex-1 flex flex-col items-center justify-center p-12 overflow-auto space-y-8">
                <div id="svg-wrapper" class="relative cursor-grab active:cursor-grabbing">
                    <div id="svg-container" class="viewer-svg"></div>
                </div>
                <div id="title-block" class="title-block w-[820px] grid grid-cols-12 p-8 text-slate-900"></div>
            </div>

            <!-- CODE -->
            <div id="code-panel" class="flex-1 hidden flex-col p-8 bg-slate-900/50 backdrop-blur overflow-hidden">
                <div class="max-w-6xl mx-auto w-full h-full flex flex-col space-y-4">
                    <div>
                        <h2 class="text-base font-semibold text-slate-100 mb-4">SVG Code</h2>
                        <div class="flex gap-x-3 flex-wrap">
                            <button onclick="validateAndShowErrors()" class="px-4 py-2.5 bg-purple-600/20 hover:bg-purple-600/30 rounded-lg border border-purple-500/50 text-purple-400 text-xs font-medium transition-all duration-200">VALIDATE</button>
                            <button onclick="loadCodeFromTextarea()" class="px-4 py-2.5 bg-emerald-600/20 hover:bg-emerald-600/30 rounded-lg border border-emerald-500/50 text-emerald-400 text-xs font-medium transition-all duration-200">LOAD CODE</button>
                            <button onclick="copyCodeWithMetadata()" class="px-4 py-2.5 bg-cyan-600/20 hover:bg-cyan-600/30 rounded-lg border border-cyan-500/50 text-cyan-400 text-xs font-medium transition-all duration-200">COPY + META</button>
                            <button onclick="copyCode()" class="px-4 py-2.5 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg border border-slate-700 text-slate-300 text-xs font-medium transition-all duration-200">COPY SVG</button>
                            <button onclick="copyGrokPrompt()" class="px-4 py-2.5 bg-blue-600/20 hover:bg-blue-600/30 rounded-lg border border-blue-500/50 text-blue-400 text-xs font-medium transition-all duration-200">GROK PROMPT</button>
                            <button onclick="loadFromJSON()" class="px-4 py-2.5 bg-green-600/20 hover:bg-green-600/30 rounded-lg border border-green-500/50 text-green-400 text-xs font-medium transition-all duration-200">LOAD JSON</button>
                            <button onclick="clearAllData()" class="px-4 py-2.5 bg-red-600/20 hover:bg-red-600/30 rounded-lg border border-red-500/50 text-red-400 text-xs font-medium transition-all duration-200">CLEAR ALL</button>
                        </div>
                    </div>
                    <div id="validation-panel" class="hidden p-4 rounded-lg border border-yellow-500/50 bg-yellow-500/10">
                        <div class="font-semibold text-yellow-400 mb-3 text-sm">Validation Results</div>
                        <div id="validation-output" class="text-xs text-yellow-200 space-y-1"></div>
                    </div>
                    <textarea id="code-text" placeholder="Paste SVG code here..." class="flex-1 bg-slate-950/50 border border-slate-700 font-mono text-xs p-6 text-emerald-300 rounded-lg resize-none focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></textarea>
                </div>
            </div>

            <!-- 3D -->
            <div id="three-panel" class="flex-1 hidden bg-slate-950 relative rounded-lg m-8">
                <canvas id="three-canvas" class="w-full h-full rounded-lg"></canvas>
            </div>

            <!-- AI -->
            <div id="ai-panel" class="flex-1 hidden flex-col p-8 bg-slate-900/50 backdrop-blur overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full space-y-6">
                    <div>
                        <h2 class="text-lg font-bold text-white mb-4">ü§ñ AI Code Generator</h2>
                        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-6 space-y-4">
                            <div>
                                <label class="text-sm font-medium text-slate-300 block mb-2">Describe Your Drawing</label>
                                <textarea id="ai-prompt" placeholder="Create a 6 √ó 4 inch mounting plate with four 0.5 inch holes in a rectangular pattern..." class="w-full px-4 py-3 bg-slate-950/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500 resize-none h-24"></textarea>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="copyAIPromptWithMetadata()" class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-semibold text-white transition-all">üìã Copy Prompt + Metadata</button>
                                <button onclick="copyDirectLink()" class="flex-1 px-4 py-2.5 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm font-semibold text-white transition-all">üîó Copy Link for AI</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-base font-semibold text-emerald-400 uppercase tracking-wider mb-4">üìå Workflow: How to Use with AI</h3>
                        <div class="space-y-3">
                            <div class="bg-slate-800/30 border border-slate-700 rounded-lg p-4">
                                <div class="font-medium text-slate-100 mb-2">üîÑ Option 1: Prompt Grok &amp; Paste Code</div>
                                <ol class="text-xs text-slate-400 space-y-1 ml-4 list-decimal">
                                    <li>Describe drawing above</li>
                                    <li>Click "Copy Prompt for Grok"</li>
                                    <li>Paste into grok.x.ai</li>
                                    <li>Grok returns SVG</li>
                                    <li>Paste in CODE tab ‚Üí LOAD CODE</li>
                                </ol>
                            </div>
                            <div class="bg-slate-800/30 border border-slate-700 rounded-lg p-4">
                                <div class="font-medium text-slate-100 mb-2">‚ö° Option 2: Direct Link (Fastest)</div>
                                <ol class="text-xs text-slate-400 space-y-1 ml-4 list-decimal">
                                    <li>Click "Copy Link for AI"</li>
                                    <li>Paste link + description into any AI</li>
                                    <li>AI opens vibedraft and builds it</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-base font-semibold text-blue-400 uppercase tracking-wider mb-4">üéØ Pro Tips</h3>
                        <ul class="text-xs text-slate-400 space-y-2">
                            <li><span class="text-blue-400">1.</span> Be specific with exact dimensions and features</li>
                            <li><span class="text-blue-400">2.</span> Reference the RULES tab templates for layout &amp; borders</li>
                            <li><span class="text-blue-400">3.</span> Ask for leaders, notes, and clean dimensioning</li>
                            <li><span class="text-blue-400">4.</span> Use Option 2 (direct link) for fastest results</li>
                            <li><span class="text-blue-400">5.</span> Iterate: "Refine the previous drawing..."</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- RULES -->
            <div id="rules-panel" class="flex-1 hidden flex-col p-8 bg-slate-900/50 backdrop-blur overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full space-y-8">
                    <div>
                        <h2 class="text-lg font-bold text-white mb-6">Drawing Guidelines &amp; Templates</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-sm font-semibold text-emerald-400 uppercase tracking-wider mb-3">Best Practices</h3>
                                <div class="grid grid-cols-2 gap-4 text-xs">
                                    <div class="constraint-item">
                                        <div class="font-medium text-slate-100">Always use the bordered frame</div>
                                        <div class="text-slate-400 mt-1">Templates include a thick outer border ‚Äì keep it visible</div>
                                    </div>
                                    <div class="constraint-item">
                                        <div class="font-medium text-slate-100">Metadata auto-populates</div>
                                        <div class="text-slate-400 mt-1">Use VIBEDRAFT_* comments at top of SVG or fill sidebar</div>
                                    </div>
                                    <div class="constraint-item">
                                        <div class="font-medium text-slate-100">Dimensions &amp; notes</div>
                                        <div class="text-slate-400 mt-1">Place leaders clearly. Units match sidebar setting</div>
                                    </div>
                                    <div class="constraint-item">
                                        <div class="font-medium text-slate-100">Viewport scaling</div>
                                        <div class="text-slate-400 mt-1">Templates scale automatically to selected paper size</div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-sm font-semibold text-blue-400 uppercase tracking-wider mb-4">Quick Start Templates</h3>
                                <div class="template-grid">
                                    <button onclick="insertTemplate('simple_rect')" class="template-button">
                                        <div class="text-xs font-semibold text-slate-100">Basic Frame</div>
                                        <div class="text-[10px] text-slate-500 mt-1">Bordered plate with dims</div>
                                    </button>
                                    <button onclick="insertTemplate('two_holes')" class="template-button">
                                        <div class="text-xs font-semibold text-slate-100">Drilled Plate</div>
                                        <div class="text-[10px] text-slate-500 mt-1">Two-hole example</div>
                                    </button>
                                    <button onclick="insertTemplate('bracket')" class="template-button">
                                        <div class="text-xs font-semibold text-slate-100">L-Bracket</div>
                                        <div class="text-[10px] text-slate-500 mt-1">Simple angled part</div>
                                    </button>
                                    <button onclick="insertTemplate('hole_pattern')" class="template-button">
                                        <div class="text-xs font-semibold text-slate-100">4-Hole Pattern</div>
                                        <div class="text-[10px] text-slate-500 mt-1">Rectangular bolt pattern</div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="h-10 bg-slate-900/50 backdrop-blur border-t border-slate-700/50 px-8 flex items-center justify-between text-[11px] text-slate-500 font-mono">
        <div class="flex-1">vibedraft v0.2 ‚Ä¢ metadata auto-populates ‚Ä¢ templates scale to viewport</div>
    </div>

    <script>
        tailwind.config = { content: [] };

        let currentSVG = '', currentUnits = 'inches', zoomLevel = 1, isDragging = false, startPanX = 0, startPanY = 0, currentLogo = '';

        const PaperSizes = {
            letter: { width: 816, height: 1056 },
            tabloid: { width: 1056, height: 816 },
            A4: { width: 794, height: 1123 },
            A3: { width: 1123, height: 1587 },
            custom: { width: 820, height: 580 }
        };

        function uploadLogo() {
            const input = document.getElementById('logo-upload');
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                currentLogo = e.target.result;
                const preview = document.getElementById('logo-preview');
                preview.innerHTML = `<img src="${currentLogo}" style="max-height: 100%; max-width: 100%; object-fit: contain;">`;
                renderTitleBlock();
            };
            reader.readAsDataURL(input.files[0]);
        }

        function validateRequired() {
            const title = document.getElementById('meta-title').value.trim();
            const dwg = document.getElementById('meta-dwg').value.trim();
            const rev = document.getElementById('meta-rev').value.trim();
            if (!title || !dwg || !rev) {
                alert('‚ö†Ô∏è Title, Drawing Number, and Revision are required.');
                return false;
            }
            return true;
        }

        function validateBeforeExport() {
            return validateRequired() && currentSVG;
        }

        function changePaperSize() {
            const size = document.getElementById('paper-size').value;
            if (PaperSizes[size]) {
                document.getElementById('paper-width').value = PaperSizes[size].width;
                document.getElementById('paper-height').value = PaperSizes[size].height;
            }
            updateSVGSize();
        }

        const SVGValidator = {
            errors: [],
            validate: function (s) {
                this.errors = [];
                try {
                    const p = new DOMParser();
                    const d = p.parseFromString(s, 'text/xml');
                    if (d.getElementsByTagName('parsererror').length > 0) {
                        this.errors.push('Invalid XML');
                        return false;
                    }
                    return !!d.querySelector('svg');
                } catch (e) {
                    this.errors.push(e.message);
                    return false;
                }
            }
        };

        // WORKING TEMPLATES WITH BORDER + SCALABLE VIEWPORT
        const Templates = {
            simple_rect: () => `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <!-- Outer drawing border -->
  <rect x="35" y="35" width="750" height="510" rx="12" fill="#f8fafc" stroke="#1e2937" stroke-width="22"/>
  <!-- Sample part -->
  <rect x="150" y="140" width="520" height="300" rx="15" fill="#e2e8f0" stroke="#334155" stroke-width="14"/>
  <!-- Dimensions -->
  <line x1="120" y1="130" x2="120" y2="460" stroke="#64748b" stroke-width="7" stroke-dasharray="9 5"/>
  <text x="95" y="300" font-family="sans-serif" font-size="26" fill="#1e2937" text-anchor="middle" font-weight="600" transform="rotate(-90 95 300)">4.00"</text>
  <line x1="140" y1="480" x2="680" y2="480" stroke="#64748b" stroke-width="7" stroke-dasharray="9 5"/>
  <text x="410" y="515" font-family="sans-serif" font-size="28" fill="#1e2937" text-anchor="middle" font-weight="600">6.50"</text>
</svg>`,

            two_holes: () => `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <!-- Outer drawing border -->
  <rect x="35" y="35" width="750" height="510" rx="12" fill="#f8fafc" stroke="#1e2937" stroke-width="22"/>
  <!-- Plate -->
  <rect x="140" y="130" width="540" height="320" rx="12" fill="#e2e8f0" stroke="#334155" stroke-width="14"/>
  <!-- Holes -->
  <circle cx="310" cy="290" r="48" fill="none" stroke="#1e2937" stroke-width="14"/>
  <circle cx="510" cy="290" r="48" fill="none" stroke="#1e2937" stroke-width="14"/>
  <!-- Dimensions -->
  <line x1="210" y1="250" x2="610" y2="250" stroke="#64748b" stroke-width="7" stroke-dasharray="9 5"/>
  <text x="410" y="235" font-family="sans-serif" font-size="27" fill="#1e2937" text-anchor="middle" font-weight="600">8.00"</text>
  <text x="310" y="370" font-family="sans-serif" font-size="24" fill="#1e2937" text-anchor="middle" font-weight="600">√ò1.10"</text>
  <text x="510" y="370" font-family="sans-serif" font-size="24" fill="#1e2937" text-anchor="middle" font-weight="600">√ò1.10"</text>
</svg>`,

            bracket: () => `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <!-- Outer drawing border -->
  <rect x="35" y="35" width="750" height="510" rx="12" fill="#f8fafc" stroke="#1e2937" stroke-width="22"/>
  <!-- L-Bracket -->
  <path d="M170 170 L170 420 L290 420 L290 260 L520 260 L520 170 Z" fill="#e2e8f0" stroke="#1e2937" stroke-width="18"/>
  <text x="410" y="500" font-family="sans-serif" font-size="28" fill="#1e2937" text-anchor="middle" font-weight="600">L-BRACKET</text>
</svg>`,

            hole_pattern: () => `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <!-- Outer drawing border -->
  <rect x="35" y="35" width="750" height="510" rx="12" fill="#f8fafc" stroke="#1e2937" stroke-width="22"/>
  <!-- Plate -->
  <rect x="150" y="130" width="520" height="320" rx="12" fill="#e2e8f0" stroke="#334155" stroke-width="14"/>
  <!-- 4 holes -->
  <circle cx="270" cy="220" r="32" fill="none" stroke="#1e2937" stroke-width="11"/>
  <circle cx="550" cy="220" r="32" fill="none" stroke="#1e2937" stroke-width="11"/>
  <circle cx="270" cy="380" r="32" fill="none" stroke="#1e2937" stroke-width="11"/>
  <circle cx="550" cy="380" r="32" fill="none" stroke="#1e2937" stroke-width="11"/>
  <text x="410" y="500" font-family="sans-serif" font-size="27" fill="#1e2937" text-anchor="middle" font-weight="600">4-HOLE PATTERN</text>
</svg>`
        };

        function insertTemplate(name) {
            if (Templates[name]) {
                currentSVG = Templates[name]();
                renderViewer();
                switchTab(0);
            }
        }

        function updateSVGSize() {
            const pw = parseFloat(document.getElementById('paper-width').value) || 820;
            const ph = parseFloat(document.getElementById('paper-height').value) || 580;
            const container = document.getElementById('svg-container');
            const svg = container.querySelector('svg');
            if (svg) {
                svg.setAttribute('width', pw);
                svg.setAttribute('height', ph);
                svg.style.width = `${pw}px`;
                svg.style.height = `${ph}px`;
                if (!svg.hasAttribute('preserveAspectRatio')) {
                    svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                }
            }
        }

        function renderViewer() {
            const c = document.getElementById('svg-container');
            c.innerHTML = currentSVG || '';
            updateSVGSize();
            renderTitleBlock();
            updateCodePanel();
        }

        function renderTitleBlock() {
            const t = document.getElementById('title-block');
            const title = document.getElementById('meta-title').value || 'Untitled Drawing';
            const dwg = document.getElementById('meta-dwg').value || 'DWG-001';
            const rev = document.getElementById('meta-rev').value || 'A';
            const mat = document.getElementById('meta-material').value || '';
            const scale = document.getElementById('meta-scale').value || '1:1';
            const drawnBy = document.getElementById('meta-drawn-by').value || '‚Äî';
            let logoHtml = '';
            if (currentLogo) {
                logoHtml = `<img src="${currentLogo}" style="height: 58px; object-fit: contain;"/>`;
            }
            t.innerHTML = `
                <div class="col-span-12 flex justify-between items-start border-b border-slate-300 pb-4">
                    <div class="flex items-start gap-4">
                        <div>${logoHtml}</div>
                        <div>
                            <div class="text-3xl font-bold tracking-tight text-slate-900">${title}</div>
                            <div class="text-sm text-slate-600 mt-1">${dwg} ‚Ä¢ REV ${rev}</div>
                        </div>
                    </div>
                    <div class="text-right text-xs text-slate-700">
                        <div>${mat}</div>
                        <div class="mt-1">${scale}</div>
                    </div>
                </div>
                <div class="col-span-12 text-[10px] pt-4 text-slate-600 grid grid-cols-3">
                    <div>DRAWN BY: ${drawnBy}</div>
                    <div class="text-center">DATE: ${new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'})}</div>
                    <div class="text-right">vibedraft</div>
                </div>`;
        }

        function switchTab(n) {
            document.querySelectorAll('[id^="tab-"]').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab-${n}`).classList.add('tab-active');

            document.getElementById('viewer-panel').classList.add('hidden');
            document.getElementById('code-panel').classList.add('hidden');
            document.getElementById('three-panel').classList.add('hidden');
            document.getElementById('ai-panel').classList.add('hidden');
            document.getElementById('rules-panel').classList.add('hidden');

            if (n === 0) document.getElementById('viewer-panel').classList.remove('hidden');
            if (n === 1) { document.getElementById('code-panel').classList.remove('hidden'); updateCodePanel(); }
            if (n === 2) { document.getElementById('three-panel').classList.remove('hidden'); initThreeIfNeeded(); }
            if (n === 3) document.getElementById('ai-panel').classList.remove('hidden');
            if (n === 4) document.getElementById('rules-panel').classList.remove('hidden');
        }

        function updateCodePanel() {
            document.getElementById('code-text').value = currentSVG;
        }

        function loadCodeFromTextarea() {
            const code = document.getElementById('code-text').value.trim();
            if (!code) return alert('Paste SVG code first');
            if (SVGValidator.validate(code)) {
                extractAndApplyMetadata(code);
                currentSVG = code;
                renderViewer();
                switchTab(0);
                alert('‚úì Drawing loaded! Metadata auto-populated where comments were found.');
            } else {
                alert('‚ùå Invalid SVG:\n' + SVGValidator.errors.join('\n'));
            }
        }

        function extractAndApplyMetadata(svgCode) {
            const titleMatch = svgCode.match(/<!-- VIBEDRAFT_TITLE: (.*?) -->/);
            const dwgMatch = svgCode.match(/<!-- VIBEDRAFT_NUMBER: (.*?) -->/);
            const revMatch = svgCode.match(/<!-- VIBEDRAFT_REVISION: (.*?) -->/);
            const matMatch = svgCode.match(/<!-- VIBEDRAFT_MATERIAL: (.*?) -->/);
            const scaleMatch = svgCode.match(/<!-- VIBEDRAFT_SCALE: (.*?) -->/);
            const drawnByMatch = svgCode.match(/<!-- VIBEDRAFT_DRAWN_BY: (.*?) -->/);
            const orientMatch = svgCode.match(/<!-- VIBEDRAFT_ORIENTATION: (.*?) -->/);

            if (titleMatch) document.getElementById('meta-title').value = titleMatch[1];
            if (dwgMatch) document.getElementById('meta-dwg').value = dwgMatch[1];
            if (revMatch) document.getElementById('meta-rev').value = revMatch[1];
            if (matMatch) document.getElementById('meta-material').value = matMatch[1];
            if (scaleMatch) document.getElementById('meta-scale').value = scaleMatch[1];
            if (drawnByMatch) document.getElementById('meta-drawn-by').value = drawnByMatch[1];
            if (orientMatch) document.getElementById('meta-orientation').value = orientMatch[1];
        }

        function getMetadataComments() {
            return `<!-- VIBEDRAFT_TITLE: ${document.getElementById('meta-title').value} -->
<!-- VIBEDRAFT_NUMBER: ${document.getElementById('meta-dwg').value} -->
<!-- VIBEDRAFT_REVISION: ${document.getElementById('meta-rev').value} -->
<!-- VIBEDRAFT_MATERIAL: ${document.getElementById('meta-material').value} -->
<!-- VIBEDRAFT_SCALE: ${document.getElementById('meta-scale').value} -->
<!-- VIBEDRAFT_DRAWN_BY: ${document.getElementById('meta-drawn-by').value} -->
<!-- VIBEDRAFT_ORIENTATION: ${document.getElementById('meta-orientation').value} -->\n`;
        }

        function copyCodeWithMetadata() {
            if (!currentSVG) return alert('No drawing to copy');
            navigator.clipboard.writeText(getMetadataComments() + currentSVG);
            alert('‚úì Copied with metadata comments!\n\nPaste back ‚Üí metadata auto-loads');
        }

        function copyCode() {
            if (!currentSVG) return alert('No drawing');
            navigator.clipboard.writeText(currentSVG);
            alert('‚úì SVG copied');
        }

        function copyAIPromptWithMetadata() {
            const desc = document.getElementById('ai-prompt').value.trim();
            if (!desc) return alert('Describe your drawing first');
            const metadata = getMetadataComments();
            const prompt = `You are an expert technical illustrator. Create a clean, professional SVG technical drawing for vibedraft.

CRITICAL REQUIREMENTS:
- Start with these exact metadata comments (before the <svg> tag):
${metadata}
- Use the exact bordered frame style shown in the RULES tab "Quick Start Templates"
- All dimensions must be accurate and clearly labeled with leaders
- Keep text readable (font-size 24-30 in SVG units)
- Return ONLY the full SVG code (no explanations)

DESCRIPTION:
${desc}

Reference the RULES tab examples for perfect layout and scaling.`;
            navigator.clipboard.writeText(prompt);
            alert('‚úì Prompt copied!\n\nPaste into Grok ‚Üí get SVG ‚Üí paste in CODE tab ‚Üí LOAD CODE');
        }

        function copyDirectLink() {
            const link = window.location.href;
            const desc = document.getElementById('ai-prompt').value.trim() || "Create a clean technical drawing";
            const full = `Please visit this vibedraft tool and create the drawing:

${link}

Drawing request: ${desc}

1. Open the link
2. Go to RULES tab to see bordered templates
3. Fill sidebar metadata if needed
4. Use AI tab or directly edit
5. Export final SVG/PDF

Thank you!`;
            navigator.clipboard.writeText(full);
            alert('‚úì Direct link + instructions copied!\n\nPaste into any AI chat ‚Äì it will open vibedraft and build it.');
        }

        function copyGrokPrompt() {
            if (!currentSVG) return alert('Create a drawing first');
            const p = `Improve this technical drawing. Keep the bordered frame and metadata comments. Make dimensions clearer if possible. Return ONLY the updated SVG code.\n\n\`\`\`svg\n${currentSVG}\n\`\`\``;
            navigator.clipboard.writeText(p);
            alert('‚úì Refinement prompt copied');
        }

        function initThreeIfNeeded() {
            if (window.threeInitialized) return;
            window.threeInitialized = true;
            const canvas = document.getElementById('three-canvas');
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth * 0.7, window.innerHeight * 0.8);
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1428);
            const camera = new THREE.PerspectiveCamera(45, 1.6, 10, 2000);
            camera.position.set(600, 500, 900);
            const light = new THREE.DirectionalLight(0xffffff, 1.6);
            light.position.set(700, 900, 800);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0xaaaaaa));
            const box = new THREE.Mesh(new THREE.BoxGeometry(420, 120, 520), new THREE.MeshPhongMaterial({ color: 0x64748b }));
            scene.add(box);
            function animate() {
                requestAnimationFrame(animate);
                box.rotation.y += 0.0012;
                renderer.render(scene, camera);
            }
            animate();
        }

        function setUnits(n) {
            document.getElementById('unit-in').classList.toggle('bg-blue-600', n === 0);
            document.getElementById('unit-in').classList.toggle('text-white', n === 0);
            document.getElementById('unit-mm').classList.toggle('bg-blue-600', n === 1);
            document.getElementById('unit-mm').classList.toggle('text-white', n === 1);
            document.getElementById('units-label').textContent = n === 0 ? 'INCHES' : 'MILLIMETERS';
            currentUnits = n === 0 ? 'inches' : 'mm';
        }

        function validateDrawing() {
            renderTitleBlock();
            alert('‚úÖ Metadata & viewport validated');
        }

        function validateAndShowErrors() {
            const s = document.getElementById('code-text').value;
            const valid = SVGValidator.validate(s);
            const panel = document.getElementById('validation-panel');
            const output = document.getElementById('validation-output');
            if (valid) {
                output.innerHTML = '<div class="success-badge p-3 rounded">‚úì Valid SVG code</div>';
            } else {
                let html = '<div class="space-y-1">';
                SVGValidator.errors.forEach(e => html += `<div class="error-badge p-3 rounded text-xs">${e}</div>`);
                html += '</div>';
                output.innerHTML = html;
            }
            panel.classList.remove('hidden');
        }

        function newDrawing() {
            if (confirm('Start a fresh drawing?')) {
                currentSVG = Templates.simple_rect();
                document.getElementById('meta-title').value = '';
                document.getElementById('meta-dwg').value = '';
                renderViewer();
                switchTab(0);
            }
        }

        function saveDrawing() {
            if (!validateRequired()) return;
            const data = {
                svg: currentSVG,
                logo: currentLogo,
                meta: {
                    title: document.getElementById('meta-title').value,
                    dwg: document.getElementById('meta-dwg').value,
                    rev: document.getElementById('meta-rev').value,
                    material: document.getElementById('meta-material').value,
                    scale: document.getElementById('meta-scale').value,
                    drawnBy: document.getElementById('meta-drawn-by').value,
                    orientation: document.getElementById('meta-orientation').value,
                    paperSize: document.getElementById('paper-size').value
                }
            };
            localStorage.setItem('vibedraft_current', JSON.stringify(data));
            alert('‚úì Saved to browser storage');
        }

        function exportSVG() {
            if (!validateBeforeExport()) return;
            const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${document.getElementById('meta-dwg').value || 'drawing'}.svg`;
            a.click();
        }

        async function exportPDF() {
            if (!validateBeforeExport()) return;
            const orientation = document.getElementById('meta-orientation').value === 'landscape' ? 'l' : 'p';
            const pageSize = document.getElementById('paper-size').value === 'letter' ? 'letter' : 
                            document.getElementById('paper-size').value === 'tabloid' ? 'tabloid' : 'a4';
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF(orientation, 'mm', pageSize);

            const title = document.getElementById('meta-title').value;
            const number = document.getElementById('meta-dwg').value;
            let y = 15;

            if (currentLogo) {
                pdf.addImage(currentLogo, 'PNG', 15, y, 25, 12);
                y += 8;
            }
            pdf.setFontSize(18);
            pdf.text(title || 'Technical Drawing', 15, y);
            y += 8;
            pdf.setFontSize(10);
            pdf.text(`${number}  REV ${document.getElementById('meta-rev').value}`, 15, y);
            y += 12;

            const wrapper = document.getElementById('svg-wrapper');
            const canvas = await html2canvas(wrapper, { scale: 3, backgroundColor: '#ffffff' });
            const imgData = canvas.toDataURL('image/png');

            const pdfW = pdf.internal.pageSize.getWidth();
            const pdfH = pdf.internal.pageSize.getHeight();
            const ratio = canvas.width / canvas.height;
            let imgW = pdfW - 30;
            let imgH = imgW / ratio;
            if (imgH > pdfH - y - 20) {
                imgH = pdfH - y - 20;
                imgW = imgH * ratio;
            }
            pdf.addImage(imgData, 'PNG', (pdfW - imgW) / 2, y, imgW, imgH);
            pdf.save(`${number || 'drawing'}.pdf`);
        }

        function loadFromJSON() {
            const json = prompt('Paste saved JSON:');
            if (!json) return;
            try {
                const d = JSON.parse(json);
                if (d.svg) currentSVG = d.svg;
                if (d.logo) {
                    currentLogo = d.logo;
                    document.getElementById('logo-preview').innerHTML = `<img src="${currentLogo}" style="max-height:100%;max-width:100%;object-fit:contain;">`;
                }
                if (d.meta) {
                    Object.keys(d.meta).forEach(k => {
                        const el = document.getElementById(`meta-${k === 'dwg' ? 'dwg' : k}`);
                        if (el) el.value = d.meta[k];
                    });
                    if (d.meta.paperSize) {
                        document.getElementById('paper-size').value = d.meta.paperSize;
                        changePaperSize();
                    }
                }
                renderViewer();
                switchTab(0);
            } catch (e) {
                alert('Invalid JSON');
            }
        }

        function clearAllData() {
            if (confirm('Clear everything and start fresh?')) {
                localStorage.removeItem('vibedraft_current');
                location.reload();
            }
        }

        function initializeApp() {
            lucide.createIcons();

            // Load saved or start with template
            const saved = localStorage.getItem('vibedraft_current');
            if (saved) {
                try {
                    const d = JSON.parse(saved);
                    currentSVG = d.svg;
                    if (d.logo) currentLogo = d.logo;
                    if (d.meta) {
                        Object.keys(d.meta).forEach(k => {
                            const el = document.getElementById(`meta-${k === 'dwg' ? 'dwg' : k}`);
                            if (el) el.value = d.meta[k] || '';
                        });
                    }
                } catch (_) {}
            } else {
                currentSVG = Templates.simple_rect();
            }

            renderViewer();
            switchTab(0);
            setUnits(0);

            // Pan & zoom
            const wrapper = document.getElementById('svg-wrapper');
            wrapper.addEventListener('wheel', e => {
                e.preventDefault();
                zoomLevel += e.deltaY * -0.0015;
                zoomLevel = Math.max(0.4, Math.min(4, zoomLevel));
                wrapper.style.transform = `scale(${zoomLevel})`;
            });

            let panX = 0, panY = 0;
            wrapper.addEventListener('mousedown', e => {
                if (e.button === 0) {
                    isDragging = true;
                    startPanX = e.clientX - panX;
                    startPanY = e.clientY - panY;
                }
            });
            window.addEventListener('mousemove', e => {
                if (!isDragging) return;
                panX = e.clientX - startPanX;
                panY = e.clientY - startPanY;
                wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${zoomLevel})`;
            });
            window.addEventListener('mouseup', () => isDragging = false);
        }

        window.onload = initializeApp;
    </script>
</body>
</html>
