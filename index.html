<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeDraft v0.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@600&display=swap');
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .tail-container {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1a1f3a 100%);
        }
        .logo-font {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -1px;
        }
        .viewer-svg {
            background: #fafbfc;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            max-width: 100%;
            max-height: 72vh;
            width: auto;
            height: auto;
        }
        .title-block {
            background: linear-gradient(to bottom, #f8fafc, #f0f4f8);
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 11px;
            line-height: 1.05;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .tab-active {
            border-bottom: 2px solid #60a5fa;
            color: #60a5fa;
            font-weight: 600;
        }
        .prompt-preview {
            background:#1e1e1e;
            color:#0f0;
            padding:12px;
            font-size:13px;
            white-space:pre-wrap;
            border-radius:8px;
            max-height:300px;
            overflow:auto;
        }
    </style>
</head>
<body class="tail-container text-slate-100 overflow-hidden h-screen flex flex-col">
    <nav class="bg-slate-900/50 backdrop-blur border-b border-slate-700/50 px-8 py-4 flex items-center justify-between">
        <div class="flex items-center gap-x-12">
            <div class="flex items-center gap-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center text-white font-bold logo-font text-lg shadow-lg">VD</div>
                <div>
                    <h1 class="logo-font text-3xl font-bold tracking-tight text-white">vibedraft</h1>
                    <span class="text-xs font-medium text-cyan-400">v0.3</span>
                </div>
            </div>
            <div class="flex gap-x-8 text-sm font-medium">
                <button onclick="switchTab(0)" id="tab-0" class="tab-active px-4 py-2 transition-colors duration-200 text-slate-300 hover:text-white">VIEWER</button>
                <button onclick="switchTab(1)" id="tab-1" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">CODE</button>
                <button onclick="switchTab(2)" id="tab-2" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">3D</button>
                <button onclick="switchTab(3)" id="tab-3" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">AI</button>
                <button onclick="switchTab(4)" id="tab-4" class="px-4 py-2 transition-colors duration-200 text-slate-400 hover:text-white">RULES</button>
            </div>
        </div>
        <div class="flex items-center gap-x-3">
            <button onclick="newDrawing()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/50 transition-colors duration-200 text-slate-300 hover:text-white">
                <i data-lucide="file-plus" class="w-4 h-4"></i>
                <span class="text-xs font-medium">New</span>
            </button>
            <button onclick="saveDrawing()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-700/50 transition-colors duration-200 text-slate-300 hover:text-white">
                <i data-lucide="save" class="w-4 h-4"></i>
                <span class="text-xs font-medium">Save</span>
            </button>
            <div class="w-px h-6 bg-slate-700/50"></div>
            <button onclick="exportSVG()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-blue-600/10 hover:bg-blue-600/20 transition-colors duration-200 text-blue-400 hover:text-blue-300">
                <i data-lucide="file-image" class="w-4 h-4"></i>
                <span class="text-xs font-medium">SVG</span>
            </button>
            <button onclick="exportPDF()" class="flex items-center gap-x-2 px-4 py-2 rounded-lg bg-blue-600/10 hover:bg-blue-600/20 transition-colors duration-200 text-blue-400 hover:text-blue-300">
                <i data-lucide="file-text" class="w-4 h-4"></i>
                <span class="text-xs font-medium">PDF</span>
            </button>
        </div>
    </nav>
    <div class="flex flex-1 overflow-hidden">
        <div class="w-80 bg-slate-900/30 backdrop-blur border-r border-slate-700/50 p-8 flex flex-col overflow-y-auto space-y-6">
            <div>
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Drafting Standard</div>
                <select id="stdSelect" onchange="updatePrompts()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                    <option value="neutral" selected>No specific standard (general engineering)</option>
                    <option value="asme">ASME Y14.5-2018</option>
                    <option value="iso">ISO 128 / ISO 1101</option>
                    <option value="custom">Custom (edit in prompt)</option>
                </select>
            </div>
            <div>
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Project Info</div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Company Logo</label>
                        <label class="block">
                            <div class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-lg text-xs text-slate-400 hover:border-blue-500 cursor-pointer transition-colors text-center">
                                üì∑ Upload Logo
                            </div>
                            <input type="file" id="logo-upload" accept="image/*" onchange="uploadLogo()" style="display:none;">
                        </label>
                        <div id="logo-preview" class="mt-2 h-12 bg-slate-800/50 border border-slate-700 rounded-lg flex items-center justify-center text-xs text-slate-500"></div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Drawing Title <span class="text-red-400">*</span></label>
                        <input type="text" id="meta-title" value="" onchange="validateRequired()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Drawing Number <span class="text-red-400">*</span></label>
                        <input type="text" id="meta-dwg" value="" onchange="validateRequired()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Revision <span class="text-red-400">*</span></label>
                        <input type="text" id="meta-rev" value="" onchange="validateRequired()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Material</label>
                        <input type="text" id="meta-material" value="" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Drawn By</label>
                        <input type="text" id="meta-drawn-by" value="" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Orientation</label>
                        <select id="meta-orientation" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                            <option value="landscape">Landscape (Default)</option>
                            <option value="portrait">Portrait</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-700/30 pt-6">
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Drawing Format</div>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Paper Size</label>
                        <select id="paper-size" onchange="changePaperSize()" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                            <option value="letter">Letter (8.5 x 11")</option>
                            <option value="tabloid">Tabloid (11 x 17")</option>
                            <option value="A4">A4 (210 x 297mm)</option>
                            <option value="A3">A3 (297 x 420mm)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-slate-400 font-medium block mb-2">Width</label>
                            <input type="number" id="paper-width" value="820" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 font-medium block mb-2">Height</label>
                            <input type="number" id="paper-height" value="580" class="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-700/30 pt-6">
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Units & Scale</div>
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between text-xs mb-3">
                            <span class="text-slate-400 font-medium">Unit System</span>
                            <span id="units-label" class="font-semibold text-blue-400">INCHES</span>
                        </div>
                        <div class="flex bg-slate-800/50 rounded-lg p-1 border border-slate-700">
                            <button onclick="setUnits(0)" id="unit-in" class="flex-1 py-2 text-xs rounded-md font-semibold active bg-blue-600 text-white">INCHES</button>
                            <button onclick="setUnits(1)" id="unit-mm" class="flex-1 py-2 text-xs rounded-md font-semibold text-slate-400 hover:text-slate-100">MM</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Scale</label>
                        <input type="text" id="meta-scale" value="1:1" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 placeholder-slate-500 focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-700/30 pt-6">
                <div class="uppercase text-xs tracking-widest text-slate-400 font-semibold mb-4">Dimension Style</div>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Dim Line Width</label>
                        <select id="dim-thickness" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                            <option value="3">Thin (3px)</option>
                            <option value="4">Light (4px)</option>
                            <option value="6" selected>Standard (6px)</option>
                            <option value="8">Bold (8px)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 font-medium block mb-2">Text Height</label>
                        <select id="text-height" class="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-sm text-slate-100 focus:outline-none focus:border-blue-500">
                            <option value="28">Small (28px)</option>
                            <option value="32" selected>Standard (32px)</option>
                            <option value="36">Large (36px)</option>
                            <option value="42">Extra Large (42px)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-700/30 pt-6 mt-auto">
                <button onclick="validateDrawing()" class="w-full py-3 px-4 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 rounded-lg text-sm font-semibold text-white transition-all duration-200 shadow-lg hover:shadow-xl">VALIDATE</button>
            </div>
        </div>
        <div class="flex-1 flex flex-col bg-slate-950/50">
            <div id="viewer-panel" class="flex-1 flex flex-col items-center justify-center p-8 overflow-auto space-y-8">
                <div id="svg-wrapper" class="relative cursor-grab active:cursor-grabbing w-full max-w-5xl">
                    <div id="svg-container" class="viewer-svg mx-auto"></div>
                </div>
                <div id="title-block" class="title-block w-full max-w-5xl grid grid-cols-12 p-8 text-slate-900"></div>
            </div>
            <div id="code-panel" class="flex-1 hidden flex-col p-8 bg-slate-900/50 backdrop-blur overflow-hidden">
                <div class="max-w-6xl mx-auto w-full h-full flex flex-col space-y-4">
                    <div>
                        <h2 class="text-base font-semibold text-slate-100 mb-4">SVG Code</h2>
                        <div class="flex gap-x-3 flex-wrap">
                            <button onclick="validateAndShowErrors()" class="px-4 py-2.5 bg-purple-600/20 hover:bg-purple-600/30 rounded-lg border border-purple-500/50 text-purple-400 text-xs font-medium transition-all duration-200">VALIDATE</button>
                            <button onclick="loadCodeFromTextarea()" class="px-4 py-2.5 bg-emerald-600/20 hover:bg-emerald-600/30 rounded-lg border border-emerald-500/50 text-emerald-400 text-xs font-medium transition-all duration-200">LOAD CODE</button>
                            <button onclick="copyCodeWithMetadata()" class="px-4 py-2.5 bg-cyan-600/20 hover:bg-cyan-600/30 rounded-lg border border-cyan-500/50 text-cyan-400 text-xs font-medium transition-all duration-200">COPY + META</button>
                            <button onclick="copyCode()" class="px-4 py-2.5 bg-slate-800/50 hover:bg-slate-700/50 rounded-lg border border-slate-700 text-slate-300 text-xs font-medium transition-all duration-200">COPY SVG</button>
                            <button onclick="loadFromJSON()" class="px-4 py-2.5 bg-green-600/20 hover:bg-green-600/30 rounded-lg border border-green-500/50 text-green-400 text-xs font-medium transition-all duration-200">LOAD JSON</button>
                            <button onclick="clearAllData()" class="px-4 py-2.5 bg-red-600/20 hover:bg-red-600/30 rounded-lg border border-red-500/50 text-red-400 text-xs font-medium transition-all duration-200">CLEAR ALL</button>
                        </div>
                    </div>
                    <div id="validation-panel" class="hidden p-4 rounded-lg border border-yellow-500/50 bg-yellow-500/10">
                        <div class="font-semibold text-yellow-400 mb-3 text-sm">Validation Results</div>
                        <div id="validation-output" class="text-xs text-yellow-200 space-y-1"></div>
                    </div>
                    <textarea id="code-text" placeholder="Paste SVG code here..." class="flex-1 bg-slate-950/50 border border-slate-700 font-mono text-xs p-6 text-emerald-300 rounded-lg resize-none focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <div id="three-panel" class="flex-1 hidden bg-slate-950 relative rounded-lg m-8">
                <canvas id="three-canvas" class="w-full h-full rounded-lg"></canvas>
            </div>
            <div id="ai-panel" class="flex-1 hidden flex-col p-8 bg-slate-900/50 backdrop-blur overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full space-y-6">
                    <h2 class="text-lg font-bold text-white mb-4">ü§ñ AI Code Generator (Grok-optimized)</h2>
                    <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 space-y-6">
                        <button onclick="copyNeutralPrompt()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 rounded-xl text-white font-semibold text-lg shadow-xl">üìã Copy Neutral Prompt + Metadata</button>
                        <button onclick="copyDirectLink()" class="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 rounded-xl text-white font-semibold text-lg shadow-xl">üîó Copy Direct Grok Link</button>
                        <button onclick="sendToGrok()" class="w-full py-4 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 rounded-xl text-white font-semibold text-lg shadow-xl">üöÄ Send to Grok (opens x.ai)</button>
                        <details class="group">
                            <summary class="cursor-pointer text-slate-300 font-medium flex items-center gap-2">Current Prompt Preview (live)</summary>
                            <pre id="promptPreview" class="prompt-preview mt-3 text-xs"></pre>
                        </details>
                    </div>
                    <div>
                        <h3 class="text-base font-semibold text-emerald-400 uppercase tracking-wider mb-4">üìå Workflow</h3>
                        <div class="space-y-3">
                            <div class="bg-slate-800/30 border border-slate-700 rounded-lg p-4">
                                <div class="font-medium text-slate-100 mb-2">üîÑ Option 1: Prompt Grok & Paste</div>
                                <ol class="text-xs text-slate-400 space-y-1 ml-4 list-decimal">
                                    <li>Describe part below or use neutral prompt</li>
                                    <li>Click Copy Neutral Prompt</li>
                                    <li>Paste in Grok ‚Üí copy SVG back</li>
                                    <li>Paste in CODE tab ‚Üí LOAD CODE</li>
                                </ol>
                            </div>
                            <div class="bg-slate-800/30 border border-slate-700 rounded-lg p-4">
                                <div class="font-medium text-slate-100 mb-2">‚ö° Option 2: Direct Send to Grok</div>
                                <ol class="text-xs text-slate-400 space-y-1 ml-4 list-decimal">
                                    <li>Click Send to Grok</li>
                                    <li>Grok opens with perfect prompt</li>
                                    <li>Grok returns SVG</li>
                                    <li>Paste in CODE tab</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="rules-panel" class="flex-1 hidden flex-col p-8 bg-slate-900/50 backdrop-blur overflow-y-auto">
                <div class="max-w-4xl mx-auto w-full space-y-8">
                    <div>
                        <h3 class="text-sm font-semibold text-emerald-400 uppercase tracking-wider mb-4">Quick Templates</h3>
                        <div class="template-grid">
                            <button onclick="insertTemplate('simple_rect')" class="template-button">
                                <div class="text-xs font-semibold text-slate-100">Simple Rect</div>
                                <div class="text-[10px] text-slate-500 mt-1">Basic plate</div>
                            </button>
                            <button onclick="insertTemplate('two_holes')" class="template-button">
                                <div class="text-xs font-semibold text-slate-100">Two Holes</div>
                                <div class="text-[10px] text-slate-500 mt-1">Plate pattern</div>
                            </button>
                            <button onclick="insertTemplate('bracket')" class="template-button">
                                <div class="text-xs font-semibold text-slate-100">L-Bracket</div>
                                <div class="text-[10px] text-slate-500 mt-1">Angular piece</div>
                            </button>
                            <button onclick="insertTemplate('hole_pattern')" class="template-button">
                                <div class="text-xs font-semibold text-slate-100">Hole Pattern</div>
                                <div class="text-[10px] text-slate-500 mt-1">4-hole array</div>
                            </button>
                            <button onclick="insertTemplate('shaft_keyway')" class="template-button">
                                <div class="text-xs font-semibold text-slate-100">Shaft + Keyway</div>
                                <div class="text-[10px] text-slate-500 mt-1">Rotating part</div>
                            </button>
                            <button onclick="insertTemplate('welded_assembly')" class="template-button">
                                <div class="text-xs font-semibold text-slate-100">Welded Assembly</div>
                                <div class="text-[10px] text-slate-500 mt-1">Fabricated frame</div>
                            </button>
                            <button onclick="insertTemplate('sheet_metal_flat')" class="template-button">
                                <div class="text-xs font-semibold text-slate-100">Sheet Metal Flat</div>
                                <div class="text-[10px] text-slate-500 mt-1">Bend pattern</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="h-10 bg-slate-900/50 backdrop-blur border-t border-slate-700/50 px-8 flex items-center justify-between text-[11px] text-slate-500 font-mono">
        <div>vibedraft v0.3</div>
    </div>
    <script>
        tailwind.config = { content: [] };
        let currentSVG = '', currentUnits = 'inches', zoomLevel = 1, isDragging = false, startPanX = 0, startPanY = 0, currentLogo = '';
        let currentStandard = "neutral";
        const PaperSizes = {
            letter: { width: 816, height: 1056, name: "Letter (8.5 x 11\")" },
            tabloid: { width: 1056, height: 816, name: "Tabloid (11 x 17\")" },
            A4: { width: 794, height: 1123, name: "A4 (210 x 297mm)" },
            A3: { width: 1123, height: 1587, name: "A3 (297 x 420mm)" },
            custom: { width: 820, height: 580, name: "Custom" }
        };
        function uploadLogo() {
            const input = document.getElementById('logo-upload');
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                currentLogo = e.target.result;
                const preview = document.getElementById('logo-preview');
                preview.innerHTML = `<img src="${currentLogo}" style="max-height: 100%; max-width: 100%; object-fit: contain;">`;
            };
            reader.readAsDataURL(input.files[0]);
        }
        function validateRequired() {
            const title = document.getElementById('meta-title').value.trim();
            const dwg = document.getElementById('meta-dwg').value.trim();
            const rev = document.getElementById('meta-rev').value.trim();
            const missing = [];
            if (!title) missing.push('Drawing Title');
            if (!dwg) missing.push('Drawing Number');
            if (!rev) missing.push('Revision');
            if (missing.length > 0) {
                alert(`‚ö†Ô∏è Missing required fields:\n‚Ä¢ ${missing.join('\n‚Ä¢ ')}\n\nThese are needed for professional drawings.`);
                return false;
            }
            return true;
        }
        function validateBeforeExport() {
            if (!validateRequired()) return false;
            if (!currentSVG) {
                alert('‚ö†Ô∏è No drawing found. Please create or load a drawing first.');
                return false;
            }
            return true;
        }
        function changePaperSize() {
            const size = document.getElementById('paper-size').value;
            if (PaperSizes[size]) {
                document.getElementById('paper-width').value = PaperSizes[size].width;
                document.getElementById('paper-height').value = PaperSizes[size].height;
            }
        }
        function getASMESettings() {
            return {
                dimThickness: parseInt(document.getElementById('dim-thickness').value),
                textHeight: parseInt(document.getElementById('text-height').value)
            };
        }
        const SVGValidator = { errors: [], validate: function (s) { this.errors = []; try { const p = new DOMParser(), d = p.parseFromString(s, 'text/xml'); if (d.getElementsByTagName('parsererror').length > 0) { this.errors.push('Parse error'); return false; } return !!d.querySelector('svg'); } catch (e) { this.errors.push('Error: ' + e.message); return false; } } };
        const Templates = {
            simple_rect: () => { const set = getASMESettings(); return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="110" y="90" width="600" height="400" rx="20" fill="#f8fafc" stroke="#1e2937" stroke-width="28"/><line x1="80" y1="90" x2="80" y2="490" stroke="#64748b" stroke-width="${set.dimThickness}" stroke-dasharray="12 8"/><line x1="710" y1="90" x2="710" y2="490" stroke="#64748b" stroke-width="${set.dimThickness}" stroke-dasharray="12 8"/><text x="50" y="300" font-family="sans-serif" font-size="${set.textHeight}" fill="#1e2937" text-anchor="middle" font-weight="600" transform="rotate(-90 50 300)">4.50"</text><line x1="110" y1="510" x2="710" y2="510" stroke="#64748b" stroke-width="${set.dimThickness}" stroke-dasharray="12 8"/><text x="410" y="545" font-family="sans-serif" font-size="${set.textHeight + 10}" fill="#1e2937" text-anchor="middle" font-weight="600">6.00"</text></svg>`; },
            two_holes: () => { const set = getASMESettings(); return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="110" y="90" width="600" height="400" rx="20" fill="#f8fafc" stroke="#1e2937" stroke-width="28"/><circle cx="310" cy="290" r="55" fill="none" stroke="#1e2937" stroke-width="16"/><circle cx="510" cy="290" r="55" fill="none" stroke="#1e2937" stroke-width="16"/><line x1="210" y1="270" x2="610" y2="270" stroke="#64748b" stroke-width="${set.dimThickness}" stroke-dasharray="12 8"/><text x="410" y="250" font-family="sans-serif" font-size="${set.textHeight + 10}" fill="#1e2937" text-anchor="middle" font-weight="600">8.00"</text><text x="310" y="380" font-family="sans-serif" font-size="${set.textHeight}" fill="#1e2937" text-anchor="middle" font-weight="600">√ò1.10"</text><text x="510" y="380" font-family="sans-serif" font-size="${set.textHeight}" fill="#1e2937" text-anchor="middle" font-weight="600">√ò1.10"</text></svg>`; },
            bracket: () => { const set = getASMESettings(); return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M 150 250 L 150 150 L 450 150 L 450 250 L 300 250 L 300 350 L 150 350 Z" fill="#f8fafc" stroke="#1e2937" stroke-width="24"/><text x="410" y="520" font-family="sans-serif" font-size="${set.textHeight}" fill="#1e2937" text-anchor="middle" font-weight="600">L-BRACKET</text></svg>`; },
            hole_pattern: () => { const set = getASMESettings(); return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="110" y="90" width="600" height="400" rx="20" fill="#f8fafc" stroke="#1e2937" stroke-width="28"/><circle cx="210" cy="190" r="35" fill="none" stroke="#1e2937" stroke-width="12"/><circle cx="610" cy="190" r="35" fill="none" stroke="#1e2937" stroke-width="12"/><circle cx="210" cy="390" r="35" fill="none" stroke="#1e2937" stroke-width="12"/><circle cx="610" cy="390" r="35" fill="none" stroke="#1e2937" stroke-width="12"/><text x="410" y="520" font-family="sans-serif" font-size="${set.textHeight}" fill="#1e2937" text-anchor="middle" font-weight="600">4-HOLE</text></svg>`; },
            shaft_keyway: () => { const set = getASMESettings(); return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="150" y="220" width="520" height="140" rx="20" fill="#f8fafc" stroke="#1e2937" stroke-width="28"/><rect x="190" y="260" width="80" height="60" fill="#e2e8f0" stroke="#1e2937" stroke-width="12"/><text x="410" y="520" font-family="sans-serif" font-size="${set.textHeight}" fill="#1e2937" text-anchor="middle" font-weight="600">SHAFT √ò2.00" KEYWAY 0.50"</text></svg>`; },
            welded_assembly: () => { const set = getASMESettings(); return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M150 150 L670 150 L670 430 L150 430 Z" fill="#f8fafc" stroke="#1e2937" stroke-width="24"/><line x1="150" y1="290" x2="670" y2="290" stroke="#ef4444" stroke-width="18" stroke-dasharray="8 8"/><text x="410" y="520" font-family="sans-serif" font-size="${set.textHeight}" fill="#1e2937" text-anchor="middle" font-weight="600">WELDED FRAME</text></svg>`; },
            sheet_metal_flat: () => { const set = getASMESettings(); return `<svg width="820" height="580" viewBox="0 0 820 580" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="120" y="120" width="580" height="340" rx="15" fill="#f8fafc" stroke="#1e2937" stroke-width="28"/><text x="410" y="520" font-family="sans-serif" font-size="${set.textHeight}" fill="#1e2937" text-anchor="middle" font-weight="600">SHEET METAL FLAT PATTERN</text></svg>`; }
        };
        function insertTemplate(n) { if (Templates[n]) { currentSVG = Templates[n](); renderViewer(); switchTab(0); } }
        function renderViewer() {
            const c = document.getElementById('svg-container');
            c.innerHTML = currentSVG;
            const s = c.querySelector('svg');
            if (s) {
                s.style.width = '100%';
                s.style.height = 'auto';
                if (!s.getAttribute('viewBox')) s.setAttribute('viewBox', '0 0 1200 900');
            }
            renderTitleBlock();
            updateCodePanel();
        }
        function renderTitleBlock() {
            const t = document.getElementById('title-block'), title = document.getElementById('meta-title').value, dwg = document.getElementById('meta-dwg').value, rev = document.getElementById('meta-rev').value, mat = document.getElementById('meta-material').value, scale = document.getElementById('meta-scale').value, drawnBy = document.getElementById('meta-drawn-by').value;
            let logoHtml = '';
            if (currentLogo) { logoHtml = `<img src="${currentLogo}" style="height: 60px; object-fit: contain;"/>`; }
            t.innerHTML = `<div class="col-span-12 flex justify-between items-start border-b border-slate-300 pb-4"><div><div class="flex items-start gap-4"><div>${logoHtml}</div><div><div class="text-3xl font-bold tracking-tight text-slate-900">${title}</div><div class="text-sm text-slate-600 mt-2">${dwg} ‚Ä¢ REV ${rev}</div></div></div></div><div class="text-right"><div class="text-xs text-slate-700 font-medium">${mat}</div><div class="text-xs text-slate-700 font-medium mt-3">${scale}</div></div></div><div class="col-span-12 text-[10px] pt-4 text-slate-600 grid grid-cols-3"><div>DRAWN BY: ${drawnBy}</div><div class="text-center">DATE: ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div><div class="text-right">REV ${rev}</div></div>`;
        }
        function switchTab(n) {
            document.querySelectorAll('[id^="tab-"]').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab-${n}`).classList.add('tab-active');
            document.getElementById('viewer-panel').classList.add('hidden');
            document.getElementById('code-panel').classList.add('hidden');
            document.getElementById('three-panel').classList.add('hidden');
            document.getElementById('ai-panel').classList.add('hidden');
            document.getElementById('rules-panel').classList.add('hidden');
            if (n === 0) document.getElementById('viewer-panel').classList.remove('hidden');
            if (n === 1) { document.getElementById('code-panel').classList.remove('hidden'); updateCodePanel(); }
            if (n === 2) { document.getElementById('three-panel').classList.remove('hidden'); initThreeIfNeeded(); }
            if (n === 3) document.getElementById('ai-panel').classList.remove('hidden');
            if (n === 4) document.getElementById('rules-panel').classList.remove('hidden');
        }
        function loadCodeFromTextarea() {
            const code = document.getElementById('code-text').value.trim();
            if (!code) { alert('‚ùå No code to load. Paste SVG code first.'); return; }
            if (SVGValidator.validate(code)) {
                extractAndApplyMetadata(code);
                currentSVG = code;
                renderViewer();
                switchTab(0);
            } else {
                alert('‚ùå Invalid SVG code. Check for errors:\n' + SVGValidator.errors.join('\n'));
            }
        }
        function extractAndApplyMetadata(svgCode) {
            const titleMatch = svgCode.match(/<!-- VIBEDRAFT_TITLE: (.*?) -->/);
            const dwiMatch = svgCode.match(/<!-- VIBEDRAFT_NUMBER: (.*?) -->/);
            const revMatch = svgCode.match(/<!-- VIBEDRAFT_REVISION: (.*?) -->/);
            const matMatch = svgCode.match(/<!-- VIBEDRAFT_MATERIAL: (.*?) -->/);
            const scaleMatch = svgCode.match(/<!-- VIBEDRAFT_SCALE: (.*?) -->/);
            const drawnByMatch = svgCode.match(/<!-- VIBEDRAFT_DRAWN_BY: (.*?) -->/);
            const orientMatch = svgCode.match(/<!-- VIBEDRAFT_ORIENTATION: (.*?) -->/);
            if (titleMatch) document.getElementById('meta-title').value = titleMatch[1];
            if (dwiMatch) document.getElementById('meta-dwg').value = dwiMatch[1];
            if (revMatch) document.getElementById('meta-rev').value = revMatch[1];
            if (matMatch) document.getElementById('meta-material').value = matMatch[1];
            if (scaleMatch) document.getElementById('meta-scale').value = scaleMatch[1];
            if (drawnByMatch) document.getElementById('meta-drawn-by').value = drawnByMatch[1];
            if (orientMatch) document.getElementById('meta-orientation').value = orientMatch[1];
        }
        function getMetadataComments() {
            const title = document.getElementById('meta-title').value;
            const dwg = document.getElementById('meta-dwg').value;
            const rev = document.getElementById('meta-rev').value;
            const mat = document.getElementById('meta-material').value;
            const scale = document.getElementById('meta-scale').value;
            const drawnBy = document.getElementById('meta-drawn-by').value;
            const orient = document.getElementById('meta-orientation').value;
            return `<!-- VIBEDRAFT_TITLE: ${title} -->\n<!-- VIBEDRAFT_NUMBER: ${dwg} -->\n<!-- VIBEDRAFT_REVISION: ${rev} -->\n<!-- VIBEDRAFT_MATERIAL: ${mat} -->\n<!-- VIBEDRAFT_SCALE: ${scale} -->\n<!-- VIBEDRAFT_DRAWN_BY: ${drawnBy} -->\n<!-- VIBEDRAFT_ORIENTATION: ${orient} -->\n`;
        }
        function copyCodeWithMetadata() {
            if (!currentSVG) { alert('‚ö†Ô∏è No drawing to copy'); return; }
            const metadata = getMetadataComments();
            const fullCode = metadata + currentSVG;
            navigator.clipboard.writeText(fullCode);
            alert('‚úì SVG copied with metadata!');
        }
        function copyCode() {
            if (!currentSVG) { alert('‚ö†Ô∏è No drawing to copy'); return; }
            navigator.clipboard.writeText(currentSVG);
            alert('‚úì SVG copied to clipboard');
        }
        function copyDirectLink() {
            const link = window.location.href;
            const desc = document.getElementById('ai-prompt') ? document.getElementById('ai-prompt').value.trim() : '';
            const fullPrompt = `Create a technical drawing using VibeDraft tool:\nTool: ${link}\nDescription: ${desc}\nUse neutral engineering conventions. Return clean SVG only.`;
            navigator.clipboard.writeText(fullPrompt);
            alert('‚úì Direct link instructions copied!');
        }
        function sendToGrok() {
            let promptText = document.getElementById("promptPreview").textContent;
            if (!promptText) promptText = "Create a clean neutral engineering drawing SVG in VibeDraft";
            const encoded = encodeURIComponent(promptText);
            window.open(`https://grok.x.ai/?prompt=${encoded}`, '_blank');
        }
        function initThreeIfNeeded() {
            if (window.threeInitialized) return;
            window.threeInitialized = true;
            const c = document.getElementById('three-canvas'), r = new THREE.WebGLRenderer({ canvas: c, antialias: true });
            r.setSize(window.innerWidth, window.innerHeight);
            const s = new THREE.Scene(); s.background = new THREE.Color(0x0a1428);
            const cam = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 10, 2000);
            cam.position.set(500, 400, 800);
            const l = new THREE.DirectionalLight(0xffffff, 1.4); l.position.set(600, 900, 700); s.add(l);
            s.add(new THREE.AmbientLight(0xaaaaaa));
            const b = new THREE.Mesh(new THREE.BoxGeometry(420, 120, 520), new THREE.MeshPhongMaterial({ color: 0x64748b }));
            s.add(b);
            function anim() { requestAnimationFrame(anim); b.rotation.y += 0.0015; r.render(s, cam); } anim();
        }
        function setUnits(n) {
            document.getElementById('unit-in').classList.toggle('active', n === 0);
            document.getElementById('unit-mm').classList.toggle('active', n === 1);
            document.getElementById('units-label').textContent = n === 0 ? 'INCHES' : 'MILLIMETERS';
            currentUnits = n === 0 ? 'inches' : 'mm';
        }
        function validateDrawing() { renderTitleBlock(); alert('Metadata validated'); }
        function validateAndShowErrors() {
            const s = document.getElementById('code-text').value, v = SVGValidator.validate(s), p = document.getElementById('validation-panel'), o = document.getElementById('validation-output');
            if (v) { o.innerHTML = '<div class="success-badge p-2 rounded">‚úì Valid SVG</div>'; } else {
                let h = '<div class="space-y-1">';
                SVGValidator.errors.forEach(e => { h += `<div class="error-badge p-2 rounded text-xs">${e}</div>`; });
                h += '</div>'; o.innerHTML = h;
            }
            p.classList.remove('hidden');
        }
        function newDrawing() {
            if (confirm('Start new drawing?')) {
                currentSVG = Templates.simple_rect();
                renderViewer();
                switchTab(0);
            }
        }
        function saveDrawing() {
            if (!validateRequired()) return;
            const d = {
                svg: currentSVG,
                logo: currentLogo,
                meta: {
                    title: document.getElementById('meta-title').value,
                    dwg: document.getElementById('meta-dwg').value,
                    rev: document.getElementById('meta-rev').value,
                    material: document.getElementById('meta-material').value,
                    scale: document.getElementById('meta-scale').value,
                    drawnBy: document.getElementById('meta-drawn-by').value,
                    orientation: document.getElementById('meta-orientation').value,
                    paperSize: document.getElementById('paper-size').value,
                    dimThickness: document.getElementById('dim-thickness').value,
                    textHeight: document.getElementById('text-height').value
                }
            };
            localStorage.setItem('vibedraft_current', JSON.stringify(d));
            alert('‚úì Drawing saved to browser');
        }
        function exportSVG() {
            if (!validateRequired()) return;
            const b = new Blob([currentSVG], { type: 'image/svg+xml' }), u = URL.createObjectURL(b), a = document.createElement('a');
            a.href = u; a.download = `${document.getElementById('meta-dwg').value || 'vibedraft'}.svg`; a.click();
        }
        async function exportPDF() {
            if (!validateBeforeExport()) return;
            const orientation = document.getElementById('meta-orientation').value || 'landscape';
            const pageSize = document.getElementById('paper-size').value || 'a4';
            const j = window.jspdf;
            const pdfOrientation = orientation === 'landscape' ? 'l' : 'p';
            const d = new j.jsPDF(pdfOrientation, 'mm', pageSize);
            const pageWidth = d.internal.pageSize.getWidth();
            const pageHeight = d.internal.pageSize.getHeight();
            const title = document.getElementById('meta-title').value;
            const number = document.getElementById('meta-dwg').value;
            const rev = document.getElementById('meta-rev').value;
            const material = document.getElementById('meta-material').value;
            const scale = document.getElementById('meta-scale').value;
            const drawnBy = document.getElementById('meta-drawn-by').value;
            const logoSrc = currentLogo;
            let yPosition = 10;
            if (logoSrc || title) {
                const logoHeight = 12;
                if (logoSrc) { d.addImage(logoSrc, 'PNG', 10, yPosition, 20, logoHeight); }
                d.setFontSize(16); d.setFont(undefined, 'bold'); d.text(title || '', logoSrc ? 35 : 10, yPosition + 4);
                d.setFontSize(9); d.setFont(undefined, 'normal'); d.text(`${number} ‚Ä¢ REV ${rev}`, logoSrc ? 35 : 10, yPosition + 10);
                yPosition += logoHeight + 5;
                d.setLineWidth(0.5); d.line(10, yPosition, pageWidth - 10, yPosition); yPosition += 3;
                const metaLineHeight = 4;
                d.setFontSize(7);
                d.text(`Material: ${material}`, pageWidth - 60, yPosition);
                d.text(`Scale: ${scale}`, pageWidth - 30, yPosition);
                d.text(`Drawn By: ${drawnBy}`, 10, yPosition);
                yPosition += metaLineHeight + 3;
            }
            const c = document.getElementById('svg-wrapper');
            const cv = await html2canvas(c, { scale: 3, backgroundColor: '#ffffff' });
            const maxWidth = pageWidth - 20;
            const maxHeight = pageHeight - yPosition - 10;
            const imgAspect = cv.width / cv.height;
            const maxAspect = maxWidth / maxHeight;
            let imgWidth, imgHeight;
            if (imgAspect > maxAspect) { imgWidth = maxWidth; imgHeight = maxWidth / imgAspect; } else { imgHeight = maxHeight; imgWidth = maxHeight * imgAspect; }
            const xCenter = (pageWidth - imgWidth) / 2;
            d.addImage(cv.toDataURL('image/png'), 'PNG', xCenter, yPosition, imgWidth, imgHeight);
            d.save(`${number || 'vibedraft'}.pdf`);
        }
        function loadFromJSON() {
            const j = prompt('Paste JSON data:');
            if (!j) return;
            try {
                const d = JSON.parse(j);
                if (d.svg) {
                    currentSVG = d.svg;
                    if (d.logo) {
                        currentLogo = d.logo;
                        const preview = document.getElementById('logo-preview');
                        if (currentLogo) preview.innerHTML = `<img src="${currentLogo}" style="max-height: 100%; max-width: 100%; object-fit: contain;">`;
                    }
                    if (d.meta) {
                        document.getElementById('meta-title').value = d.meta.title || '';
                        document.getElementById('meta-dwg').value = d.meta.dwg || '';
                        document.getElementById('meta-rev').value = d.meta.rev || '';
                        document.getElementById('meta-material').value = d.meta.material || '';
                        document.getElementById('meta-scale').value = d.meta.scale || '';
                        document.getElementById('meta-drawn-by').value = d.meta.drawnBy || '';
                        document.getElementById('meta-orientation').value = d.meta.orientation || 'landscape';
                        if (d.meta.paperSize) {
                            document.getElementById('paper-size').value = d.meta.paperSize;
                            changePaperSize();
                        }
                        if (d.meta.dimThickness) document.getElementById('dim-thickness').value = d.meta.dimThickness;
                        if (d.meta.textHeight) document.getElementById('text-height').value = d.meta.textHeight;
                    }
                    renderViewer();
                    switchTab(0);
                }
            } catch (e) { alert('‚ùå Invalid JSON format'); }
        }
        function clearAllData() {
            if (confirm('Clear all saved data and start fresh?\n\nThis cannot be undone.')) {
                localStorage.removeItem('vibedraft_current');
                location.reload();
            }
        }
        function updatePrompts() {
            currentStandard = document.getElementById("stdSelect").value;
        }
        function copyNeutralPrompt() {
            const units = currentUnits || "inches";
            const scale = document.getElementById("meta-scale").value || "1:1";
            let stdText = "";
            if (currentStandard === "asme") stdText = "Follow ASME Y14.5-2018 exactly: proper dimension placement, GD&T where logical, 90¬∞ aligned leaders.";
            else if (currentStandard === "iso") stdText = "Follow ISO 128 and ISO 1101: first-angle projection preferred, proper datum structure.";
            else stdText = "Use clean, readable engineering drawing conventions. NO forced ASME or ISO rules unless they make sense.";
            const prompt = `You are an expert mechanical CAD drafter. Create a complete, valid SVG (viewBox="0 0 1200 900") for the following part description.

${stdText}

Paper size: automatic based on content (NEVER assume tabloid/11x17 unless I say so).
Units: ${units}
Scale: ${scale}
Output ONLY the raw <svg>...</svg> code. Include title block with "DRAWN BY: AI", date, and revision 0.
Add clear, correctly terminated dimensions and notes. Use stroke="#111" for lines, #000 for text.

Part description: [PASTE YOUR DESCRIPTION HERE]`;
            navigator.clipboard.writeText(prompt);
            document.getElementById("promptPreview").textContent = prompt;
            alert("‚úÖ Neutral prompt copied! Paste into Grok and copy the SVG back.");
        }
        function updateCodePanel() {
            if (document.getElementById('code-text')) document.getElementById('code-text').value = currentSVG || '';
        }
        function initializeApp() {
            lucide.createIcons();
            const saved = localStorage.getItem('vibedraft_current');
            if (saved) {
                const d = JSON.parse(saved);
                currentSVG = d.svg;
                currentLogo = d.logo || '';
                if (d.meta) {
                    document.getElementById('meta-title').value = d.meta.title || '';
                    document.getElementById('meta-dwg').value = d.meta.dwg || '';
                    document.getElementById('meta-rev').value = d.meta.rev || '';
                    document.getElementById('meta-material').value = d.meta.material || '';
                    document.getElementById('meta-scale').value = d.meta.scale || '1:1';
                    document.getElementById('meta-drawn-by').value = d.meta.drawnBy || '';
                    document.getElementById('meta-orientation').value = d.meta.orientation || 'landscape';
                    if (d.meta.paperSize) document.getElementById('paper-size').value = d.meta.paperSize;
                    if (d.meta.dimThickness) document.getElementById('dim-thickness').value = d.meta.dimThickness;
                    if (d.meta.textHeight) document.getElementById('text-height').value = d.meta.textHeight;
                }
            } else {
                currentSVG = Templates.two_holes();
            }
            renderViewer();
            switchTab(0);
            setUnits(0);
            const w = document.getElementById('svg-wrapper');
            w.addEventListener('wheel', e => {
                e.preventDefault();
                zoomLevel += e.deltaY * -0.001;
                zoomLevel = Math.max(0.5, Math.min(3, zoomLevel));
                w.style.transform = `scale(${zoomLevel})`;
            });
            w.addEventListener('mousedown', e => {
                if (e.button === 0) {
                    isDragging = true;
                    startPanX = e.clientX;
                    startPanY = e.clientY;
                }
            });
            window.addEventListener('mousemove', e => {
                if (!isDragging) return;
                const dx = e.clientX - startPanX, dy = e.clientY - startPanY;
                w.style.transform = `translate(${dx}px, ${dy}px) scale(${zoomLevel})`;
            });
            window.addEventListener('mouseup', () => isDragging = false);
        }
        window.onload = initializeApp;
    </script>
</body>
</html>
